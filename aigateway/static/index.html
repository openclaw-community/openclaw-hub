<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Hub Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0e17;
            --surface: #111827;
            --surface-alt: #1a2332;
            --border: #1e2d3d;
            --border-light: #2a3a4d;
            --text: #e2e8f0;
            --text-muted: #8899aa;
            --text-dim: #556677;
            --accent: #22d3ee;
            --accent-dim: rgba(34, 211, 238, 0.12);
            --green: #34d399;
            --green-dim: rgba(52, 211, 153, 0.12);
            --yellow: #fbbf24;
            --yellow-dim: rgba(251, 191, 36, 0.12);
            --red: #f87171;
            --red-dim: rgba(248, 113, 113, 0.12);
            --purple: #a78bfa;
            --purple-dim: rgba(167, 139, 250, 0.12);
            --pink: #f472b6;
            --orange: #fb923c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        header {
            height: 65px;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Layout */
        #app-body { display: flex; min-height: calc(100vh - 65px); }

        /* Sidebar */
        nav#sidebar {
            width: 200px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }
        .nav-btn:hover { background: var(--surface-alt); }
        .nav-btn.active { background: var(--accent-dim); color: var(--accent); }

        /* Main content */
        main#content {
            flex: 1;
            padding: 28px;
            overflow-y: auto;
            max-height: calc(100vh - 65px);
        }

        /* Views */
        .view { animation: fadeIn 0.3s ease-out; }

        /* Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        /* Stat grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        @media (max-width: 1200px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }

        /* Buttons */
        .btn {
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            padding: 10px 18px;
            font-size: 14px;
        }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-danger { background: var(--red); color: white; }
        .btn:disabled { opacity: 0.4; cursor: default; }

        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 2px;
            background: var(--surface-alt);
            border-radius: 8px;
            padding: 3px;
        }
        .tab-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            letter-spacing: 0.03em;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: var(--bg); }

        /* Status dot */
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Mono font helper */
        .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            padding: 10px 16px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--surface-alt);
        }
        .data-table td { padding: 12px 16px; border-top: 1px solid var(--border); }
        .data-table tr:hover td { background: var(--surface-alt); }

        /* Modal */
        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        #modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            width: 520px;
            max-width: 92vw;
            max-height: 88vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Input */
        .form-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 16px; }
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            font-family: inherit;
            width: 100%;
        }
        .form-input:focus { border-color: var(--accent); }
        .form-hint { font-size: 11px; color: var(--text-dim); }

        /* Sidebar footer */
        #sidebar-footer {
            margin-top: auto;
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            z-index: 2000;
            display: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            max-width: 380px;
            line-height: 1.4;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
        }
        #toast.success { background: var(--green-dim); border: 1px solid rgba(52,211,153,0.3); color: var(--green); }
        #toast.warning { background: var(--yellow-dim); border: 1px solid rgba(251,191,36,0.3); color: var(--yellow); }
        #toast.error { background: var(--red-dim); border: 1px solid rgba(248,113,113,0.3); color: var(--red); }
    </style>
</head>
<body>
    <header>
        <a href="/" style="display:flex;align-items:center;gap:14px;text-decoration:none;color:inherit" title="OpenClaw Hub home">
            <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22d3ee,#a78bfa);display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(34,211,238,0.3);color:#0a0e17">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div>
                <div style="font-size:16px;font-weight:700;letter-spacing:-.02em">OpenClaw Hub</div>
                <div style="font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace">127.0.0.1:8080</div>
            </div>
        </a>
        <div style="display:flex;align-items:center;gap:16px">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--green)">
                <span style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)"></span>
                <span id="header-conn-count">‚Äî active</span>
            </div>
        </div>
    </header>

    <div id="app-body">
        <nav id="sidebar"></nav>
        <main id="content">
            <div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-dim)">Loading...</div>
        </main>
    </div>

    <div id="modal-overlay"></div>
    <div id="toast"></div>

    <script>
// ============================================================
// CONSTANTS
// ============================================================

const COLORS = {
    bg: '#0a0e17', surface: '#111827', surfaceAlt: '#1a2332',
    border: '#1e2d3d', text: '#e2e8f0', textMuted: '#8899aa', textDim: '#556677',
    accent: '#22d3ee', accentDim: 'rgba(34,211,238,0.12)',
    green: '#34d399', greenDim: 'rgba(52,211,153,0.12)',
    yellow: '#fbbf24', yellowDim: 'rgba(251,191,36,0.12)',
    red: '#f87171', redDim: 'rgba(248,113,113,0.12)',
    purple: '#a78bfa', purpleDim: 'rgba(167,139,250,0.12)',
    pink: '#f472b6', orange: '#fb923c'
};

const PROVIDER_COLORS = {
    ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa',
    elevenlabs: '#f472b6', github: '#e2e8f0', sora: '#fb923c',
    kie: '#38bdf8', openrouter: '#a78bfa', getlate: '#fbbf24',
    lmstudio: '#34d399', google: '#34d399', gitlab: '#fb923c', custom: '#8899aa'
};

const ICONS = {
    shield: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
    barChart: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
    server: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="7" cy="6" r="1" fill="currentColor"/><circle cx="7" cy="18" r="1" fill="currentColor"/></svg>`,
    dollar: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
    list: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    zap: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
    activity: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
    plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
    refresh: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
    x: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
    check: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
    alert: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
    lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    settings: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
    hardDrive: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="12" x2="2" y2="12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><circle cx="12" cy="17" r="1" fill="currentColor"/></svg>`,
    cloud: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
    mic: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`,
    video: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
    gitBranch: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>`,
    globe: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
    fileText: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
    trash: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`,
    edit: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
    eye: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`,
    eyeOff: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`,
    search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
};

const SERVICE_ICONS = {
    HardDrive: ICONS.hardDrive, Cloud: ICONS.cloud, Mic: ICONS.mic,
    Video: ICONS.video, GitBranch: ICONS.gitBranch, Globe: ICONS.globe,
    FileText: ICONS.fileText, Settings: ICONS.settings, Server: ICONS.server,
};

const SERVICE_TEMPLATES = {
    ollama:     { name: "Ollama (Local)",        category: "LLM (Local)",    icon: "HardDrive", color: "#34d399", fields: { baseUrl: true, apiKey: false, token: false, credPath: false }, defaults: { baseUrl: "http://127.0.0.1:11434" }, hint: "Local inference server ‚Äî no authentication required" },
    openai:     { name: "OpenAI",                category: "LLM",            icon: "Cloud",     color: "#22d3ee", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.openai.com/v1" }, hint: "Requires an API key from platform.openai.com" },
    anthropic:  { name: "Anthropic",             category: "LLM",            icon: "Cloud",     color: "#a78bfa", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.anthropic.com/v1" }, hint: "Requires an API key from console.anthropic.com" },
    elevenlabs: { name: "ElevenLabs",            category: "Media / Audio",  icon: "Mic",       color: "#f472b6", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.elevenlabs.io/v1" }, hint: "Text-to-speech and voice cloning API" },
    sora:       { name: "Sora 2 (OpenAI)",       category: "Media / Video",  icon: "Video",     color: "#fb923c", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.openai.com/v1" }, hint: "Uses your OpenAI API key ‚Äî video generation endpoints" },
    kie:        { name: "Kie.ai",                category: "Media / Video",  icon: "Video",     color: "#38bdf8", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.kie.ai" }, hint: "Cost-effective video generation ‚Äî $0.24/5s" },
    github:     { name: "GitHub",                category: "Git / DevOps",   icon: "GitBranch", color: "#e2e8f0", fields: { baseUrl: false, apiKey: false, token: true,  credPath: false }, defaults: { baseUrl: "https://api.github.com" }, hint: "Personal Access Token with repo + workflow scopes" },
    gitlab:     { name: "GitLab",                category: "Git / DevOps",   icon: "GitBranch", color: "#fb923c", fields: { baseUrl: true, apiKey: false, token: true,  credPath: false }, defaults: { baseUrl: "https://gitlab.com/api/v4" }, hint: "PAT or project token ‚Äî self-hosted instances need custom URL" },
    google:     { name: "Google (Drive/Sheets)", category: "Data",           icon: "FileText",  color: "#34d399", fields: { baseUrl: false, apiKey: false, token: false, credPath: true  }, defaults: { baseUrl: "" }, hint: "Path to service account credentials JSON file" },
    openrouter: { name: "OpenRouter",            category: "Gateway",        icon: "Globe",     color: "#a78bfa", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://openrouter.ai/api/v1" }, hint: "Multi-model gateway ‚Äî drop-in OpenAI compatible" },
    getlate:    { name: "getlate.dev",           category: "Gateway",        icon: "Globe",     color: "#fbbf24", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.getlate.dev/v1" }, hint: "API gateway with rate limiting and caching" },
    lmstudio:   { name: "LM Studio",             category: "LLM (Local)",    icon: "HardDrive", color: "#34d399", fields: { baseUrl: true, apiKey: false, token: false, credPath: false }, defaults: { baseUrl: "http://127.0.0.1:1234/v1" }, hint: "Local model server ‚Äî OpenAI-compatible API" },
    custom:     { name: "Custom Service",        category: "Custom",         icon: "Settings",  color: "#8899aa", fields: { baseUrl: true, apiKey: true,  token: true,  credPath: true  }, defaults: { baseUrl: "" }, hint: "Configure any service ‚Äî enable only the fields you need" },
};

const CATEGORY_ORDER = ["LLM", "LLM (Local)", "Media / Audio", "Media / Video", "Git / DevOps", "Data", "Gateway", "Custom"];

// ============================================================
// STATE
// ============================================================

let currentView = 'overview';
let currentPeriod = 'daily';
let currentNavDate = null; // null = current period; ISO string = historical anchor date

let statsData = null;
let usageData = {};
let connectionsData = [];
let requestsData = [];
let apiCallsData = [];   // non-LLM API calls (github, social, etc.)
let costsData = [];
let budgetData = null;  // legacy global budget (kept for backward compat)
let activeAlertsData = [];  // live alerts from /api/alerts/active (Issue #29)

let tokenChart = null;
let serviceChart = null; // requests-by-service bar chart
let pieChart = null;
let costChart = null;

// ============================================================
// API FUNCTIONS
// ============================================================

async function apiFetch(url) {
    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
    } catch (e) {
        console.error(`API error ${url}:`, e);
        return null;
    }
}

async function loadStats() {
    statsData = await apiFetch('/api/dashboard/stats');
}

function _usageCacheKey(period, navDate) {
    // For daily with no date, use the simple key to preserve 30-day trend caching.
    if (period === 'daily' && !navDate) return period;
    return `${period}__${navDate || 'current'}`;
}

async function loadUsage(period, navDate) {
    const key = _usageCacheKey(period, navDate);
    if (!usageData[key]) {
        let url = `/api/dashboard/usage?period=${period}`;
        if (navDate) url += `&date=${navDate}`;
        else if (period !== 'daily') {
            // Weekly/monthly without explicit date = current period (pass today so
            // the API returns the right week/month rather than a cached stale result)
            const today = new Date().toISOString().slice(0, 10);
            url += `&date=${today}`;
        }
        const data = await apiFetch(url);
        if (data) usageData[key] = data;
    }
    return usageData[key];
}

async function loadConnections() {
    const data = await apiFetch('/api/dashboard/connections');
    if (data) connectionsData = data.connections;
}

async function loadRequests(limit = 50) {
    const data = await apiFetch(`/api/dashboard/requests?limit=${limit}`);
    if (data) requestsData = data.requests;
}

async function loadApiCalls(limit = 50) {
    const data = await apiFetch(`/api/dashboard/api-calls?limit=${limit}`);
    if (data) apiCallsData = data.api_calls;
}

async function loadCosts() {
    const data = await apiFetch('/api/dashboard/costs');
    if (data) costsData = data.costs;
}

async function loadBudget() {
    budgetData = await apiFetch('/api/dashboard/budget');
}

async function loadActiveAlerts() {
    const data = await apiFetch('/api/alerts/active');
    if (data) activeAlertsData = data.alerts || [];
}

async function dismissAlert(alertId) {
    try {
        await fetch(`/api/alerts/${encodeURIComponent(alertId)}/dismiss`, { method: 'POST' });
        await loadActiveAlerts();
        // Re-render current view to refresh banners
        const bannerEls = document.querySelectorAll('[data-alert-id]');
        bannerEls.forEach(el => { if (el.dataset.alertId === alertId) el.remove(); });
    } catch (e) {
        console.error('dismiss alert failed:', e);
    }
}

// ============================================================
// HELPERS
// ============================================================

function formatNum(n) {
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(0) + 'k';
    return String(n);
}

function formatLatency(ms) {
    if (!ms) return '‚Äî';
    if (ms > 10000) return (ms / 1000).toFixed(1) + 's';
    return ms + 'ms';
}

function formatCost(usd) {
    if (!usd || usd === 0) return '<span style="color:var(--green)">FREE</span>';
    return '<span style="color:var(--yellow)">$' + usd.toFixed(4) + '</span>';
}

function formatCountdown(isoStr) {
    if (!isoStr) return '';
    const ms = new Date(isoStr) - Date.now();
    if (ms <= 0) return 'now';
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function budgetBannerHtml() {
    const s = statsData || {};
    const blocked = s.blocked_connections || [];
    const warnings = s.warning_connections || [];

    if (blocked.length === 0 && warnings.length === 0) return '';

    const banners = [];

    if (blocked.length > 0) {
        const first = blocked[0];
        const countdown = formatCountdown(first.resets_at);
        const extra = blocked.length > 1 ? ` <a href="#" onclick="navigateTo('costs');return false;" style="color:var(--red);text-decoration:underline">+${blocked.length - 1} more</a>` : '';
        banners.push(`
            <div style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--red-dim);border:1px solid rgba(248,113,113,0.35);border-radius:10px">
                <span style="color:var(--red);flex-shrink:0;font-size:16px">‚õî</span>
                <span style="font-size:13px;color:var(--red);font-weight:600;flex:1">
                    <strong>${first.name}</strong> BLOCKED ‚Äî ${first.reason} budget exceeded ($${(first.spent_usd||0).toFixed(2)} / $${(first.limit_usd||0).toFixed(2)}). Resets in ${countdown}${extra}
                </span>
                <button class="btn btn-sm" style="background:var(--red);color:white;flex-shrink:0" onclick="confirmBudgetOverride(${first.id})">Resume</button>
            </div>
        `);
    }

    if (warnings.length > 0) {
        const first = warnings[0];
        const pct = first.pct || 0;
        const countdown = formatCountdown(first.resets_at);
        const extra = warnings.length > 1 ? ` <a href="#" onclick="navigateTo('costs');return false;" style="color:var(--yellow);text-decoration:underline">+${warnings.length - 1} more</a>` : '';
        banners.push(`
            <div style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--yellow-dim);border:1px solid rgba(251,191,36,0.3);border-radius:10px">
                <span style="color:var(--yellow);flex-shrink:0">${ICONS.alert}</span>
                <span style="font-size:13px;color:var(--yellow);font-weight:600;flex:1">
                    <strong>${first.name}</strong> ${first.period} budget ${pct}% used ‚Äî $${(first.spent_usd||0).toFixed(2)} of $${(first.limit_usd||0).toFixed(2)}. Resets in ${countdown}${extra}
                </span>
            </div>
        `);
    }

    return `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">${banners.join('')}</div>`;
}

function formatTime(isoStr) {
    if (!isoStr) return '‚Äî';
    const d = new Date(isoStr);
    return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

// ============================================================
// CHART NAVIGATION HELPERS (Issue #33)
// ============================================================

function _isoToday() { return new Date().toISOString().slice(0, 10); }

function _anchorDate() { return currentNavDate || _isoToday(); }

function _isCurrentPeriod() {
    if (!currentNavDate) return true;
    const today = _isoToday();
    if (currentPeriod === 'daily') return currentNavDate === today;
    const mondayOf = iso => { const d = new Date(iso + 'T00:00:00Z'); const day = d.getUTCDay(); d.setUTCDate(d.getUTCDate() - (day === 0 ? 6 : day - 1)); return d.toISOString().slice(0,10); };
    if (currentPeriod === 'weekly') return mondayOf(currentNavDate) === mondayOf(today);
    if (currentPeriod === 'monthly') return currentNavDate.slice(0,7) === today.slice(0,7);
    return true;
}

function _fmtDateLabel(isoStr) {
    if (!isoStr) return '';
    const d = new Date(isoStr + 'T00:00:00Z');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
}

function _addDays(isoStr, n) {
    const d = new Date(isoStr + 'T00:00:00Z');
    d.setUTCDate(d.getUTCDate() + n);
    return d.toISOString().slice(0, 10);
}

function periodLabel() {
    if (currentPeriod === 'daily') return _isCurrentPeriod() ? 'Today' : _fmtDateLabel(currentNavDate);
    const key = _usageCacheKey(currentPeriod, currentNavDate);
    const cached = usageData[key];
    if (currentPeriod === 'weekly') {
        const ws = cached?.week_start;
        if (ws) return 'Week of ' + _fmtDateLabel(ws);
        return _isCurrentPeriod() ? 'This Week' : 'Week of ' + _fmtDateLabel(_anchorDate());
    }
    if (currentPeriod === 'monthly') {
        const mo = cached?.month;
        if (mo) { const [y,m] = mo.split('-'); return new Date(+y, +m-1, 1).toLocaleDateString('en-US',{month:'long',year:'numeric'}); }
        return _isCurrentPeriod() ? 'This Month' : _anchorDate().slice(0,7);
    }
    return '';
}

async function navigatePeriod(delta) {
    const anchor = _anchorDate();
    let newDate;
    if (currentPeriod === 'daily') {
        newDate = _addDays(anchor, delta);
    } else if (currentPeriod === 'weekly') {
        newDate = _addDays(anchor, delta * 7);
    } else {
        const [y, m] = anchor.slice(0,7).split('-').map(Number);
        let nm = m + delta, ny = y;
        if (nm < 1) { nm = 12; ny--; }
        if (nm > 12) { nm = 1; ny++; }
        newDate = `${ny}-${String(nm).padStart(2,'0')}-01`;
    }
    if (newDate > _isoToday()) return;
    currentNavDate = newDate;
    await loadUsage(currentPeriod, currentNavDate);
    renderChartArea();
}

async function jumpToCurrent() {
    currentNavDate = null;
    await loadUsage(currentPeriod, null);
    renderChartArea();
}

function navControlsHtml() {
    if (currentPeriod === 'daily') return ''; // Day view = 30-day trend, no nav needed
    const key = _usageCacheKey(currentPeriod, currentNavDate);
    const cached = usageData[key];
    const oldestDate = cached?.oldest_date || null;
    const onCurrent = _isCurrentPeriod();
    const anchor = _anchorDate();

    let leftDisabled = false;
    if (oldestDate) {
        let prevDate;
        if (currentPeriod === 'weekly') { prevDate = _addDays(anchor, -7); }
        else { const [y,m] = anchor.slice(0,7).split('-').map(Number); let nm=m-1,ny=y; if(nm<1){nm=12;ny--;} prevDate=`${ny}-${String(nm).padStart(2,'0')}-01`; }
        leftDisabled = prevDate < oldestDate;
    }

    const currentBtn = !onCurrent
        ? `<button class="btn btn-ghost btn-sm" onclick="jumpToCurrent()" style="font-size:11px;padding:4px 10px">Current</button>`
        : '';
    return `<div style="display:flex;align-items:center;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="navigatePeriod(-1)" ${leftDisabled?'disabled':''} style="padding:4px 10px;font-size:15px;line-height:1">‚Üê</button>
        <span style="font-size:12px;font-weight:600;color:var(--text-muted);min-width:150px;text-align:center">${periodLabel()}</span>
        <button class="btn btn-ghost btn-sm" onclick="navigatePeriod(1)" ${onCurrent?'disabled':''} style="padding:4px 10px;font-size:15px;line-height:1">‚Üí</button>
        ${currentBtn}
    </div>`;
}

function restartBannerHtml() {
    const startup = statsData?.startup;
    if (!startup?.unexpected_restart) return '';
    const prev = startup.previous_startup_at ? new Date(startup.previous_startup_at).toLocaleString() : 'unknown';
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--yellow-dim);border:1px solid rgba(251,191,36,0.3);border-radius:10px">
        <span style="color:var(--yellow);flex-shrink:0">‚ö†Ô∏è</span>
        <span style="font-size:13px;color:var(--yellow);font-weight:600">Hub restarted unexpectedly. Previous session started at ${prev}. Check logs for details.</span>
    </div>`;
}

function healthBannerHtml() {
    const degraded = statsData?.degraded_providers || [];
    if (degraded.length === 0) return '';
    const names = degraded.map(d => `<strong>${d.provider}</strong> (${d.status})`).join(', ');
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--yellow-dim);border:1px solid rgba(251,191,36,0.3);border-radius:10px">
        <span style="color:var(--yellow);flex-shrink:0">${ICONS.alert}</span>
        <span style="font-size:13px;color:var(--yellow);font-weight:600">Degraded: ${names}. Hub is retrying and probing for recovery.</span>
    </div>`;
}

function alertsBannerHtml() {
    if (!activeAlertsData || activeAlertsData.length === 0) return '';

    const SEVERITY_STYLE = {
        critical: { bg: 'var(--red-dim)',    border: 'rgba(248,113,113,0.35)', color: 'var(--red)',    icon: 'üî¥' },
        error:    { bg: 'var(--red-dim)',    border: 'rgba(248,113,113,0.35)', color: 'var(--red)',    icon: '‚õî' },
        warning:  { bg: 'var(--yellow-dim)', border: 'rgba(251,191,36,0.3)',   color: 'var(--yellow)', icon: '‚ö†Ô∏è' },
    };

    const banners = activeAlertsData.map(alert => {
        const sty = SEVERITY_STYLE[alert.severity] || SEVERITY_STYLE.warning;
        const tsAgo = alert.created_at ? (() => {
            const diff = Math.floor((Date.now() - new Date(alert.created_at)) / 60000);
            return diff < 1 ? 'just now' : diff < 60 ? `${diff}m ago` : `${Math.floor(diff/60)}h ago`;
        })() : '';
        return `
            <div data-alert-id="${alert.id}" style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:${sty.bg};border:1px solid ${sty.border};border-radius:10px">
                <span style="flex-shrink:0;font-size:16px">${sty.icon}</span>
                <span style="font-size:13px;color:${sty.color};font-weight:600;flex:1">
                    ${alert.message}
                    ${tsAgo ? `<span style="font-weight:400;opacity:0.7;margin-left:6px">${tsAgo}</span>` : ''}
                </span>
                <button class="btn btn-sm" style="flex-shrink:0;opacity:0.7" onclick="dismissAlert('${alert.id}')" title="Dismiss">‚úï</button>
            </div>`;
    });

    return `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">${banners.join('')}</div>`;
}

function allBannersHtml() {
    return [restartBannerHtml(), healthBannerHtml(), budgetBannerHtml(), alertsBannerHtml()]
        .filter(Boolean).join('');
}

function statusDot(status) {
    const colors = { healthy: '#34d399', degraded: '#fbbf24', error: '#f87171', offline: '#556677', unknown: '#556677' };
    const color = colors[status] || colors.unknown;
    const pulse = (status !== 'healthy' && status !== 'offline') ? 'animation:pulse 2s infinite;' : '';
    return `<span style="display:inline-flex;align-items:center;gap:6px">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};box-shadow:0 0 8px ${color}60;${pulse}display:inline-block;flex-shrink:0"></span>
        <span style="color:${color};font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">${status}</span>
    </span>`;
}

function serviceBadge(service) {
    const tpl = SERVICE_TEMPLATES[service] || SERVICE_TEMPLATES.custom;
    const color = tpl.color;
    return `<span style="display:inline-flex;align-items:center;font-size:11px;font-weight:700;color:${color};background:${color}18;padding:2px 8px;border-radius:4px;letter-spacing:.04em">${tpl.category}</span>`;
}

function serviceIcon(service, size = 16) {
    const tpl = SERVICE_TEMPLATES[service] || SERVICE_TEMPLATES.custom;
    const iconSvg = SERVICE_ICONS[tpl.icon] || ICONS.server;
    const color = tpl.color;
    return iconSvg
        .replace(/width="\d+"/, `width="${size}"`)
        .replace(/height="\d+"/, `height="${size}"`)
        .replace('currentColor', color);
}

// ============================================================
// VIEW: OVERVIEW
// ============================================================

function renderOverview() {
    const s = statsData || {};
    const budget = s.budget || {};
    const tokens = s.tokens_today || 0;
    const reqs = s.requests_24h || 0;
    const llmReqs = s.llm_requests_24h || 0;
    const apiReqs = s.api_calls_24h || 0;
    const errors = s.errors_24h || 0;
    const cost = s.estimated_daily_cost_usd || 0;
    const active = s.active_connections || 0;
    const total = s.total_connections || 0;
    const dailyPct = budget.daily_pct || 0;

    const alertBanner = allBannersHtml();

    const statCards = [
        { icon: ICONS.zap,      label: 'Tokens Today',    value: formatNum(tokens),      sub: 'Across all providers',              color: '#22d3ee' },
        { icon: ICONS.activity, label: 'Requests (24h)',  value: reqs.toLocaleString(),  sub: `${llmReqs} LLM ¬∑ ${apiReqs} API calls`, color: '#34d399' },
        { icon: ICONS.dollar,   label: 'Est. Daily Cost', value: '$' + cost.toFixed(2),  sub: `Budget: $${budget.daily_limit || 5}`, color: '#fbbf24' },
        { icon: ICONS.server,   label: 'Connections',     value: String(active),         sub: `${total} configured`,               color: '#a78bfa' },
    ].map(({ icon, label, value, sub, color }) => `
        <div class="card" style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;align-items:center;gap:8px">
                <div style="width:32px;height:32px;border-radius:8px;background:${color}15;display:flex;align-items:center;justify-content:center;color:${color}">${icon}</div>
                <span style="font-size:12px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.06em">${label}</span>
            </div>
            <div class="mono" style="font-size:28px;font-weight:700;color:var(--text);letter-spacing:-.02em">${value}</div>
            <div style="font-size:12px;color:var(--text-dim)">${sub}</div>
        </div>
    `).join('');

    const healthRows = connectionsData.length === 0
        ? `<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:16px">No connections configured</div>`
        : connectionsData.map(conn => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface-alt);border-radius:8px;opacity:${conn.enabled ? 1 : 0.4}">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="color:${(SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom).color}">${serviceIcon(conn.service, 14)}</span>
                    <span style="font-size:13px;font-weight:600">${conn.name}</span>
                    ${statusDot(conn.enabled ? conn.status : 'offline')}
                </div>
                <div style="display:flex;align-items:center;gap:14px;font-size:12px;color:var(--text-dim)">
                    <span class="mono">${formatLatency(conn.latency_avg_ms)}</span>
                    <span>${conn.requests_24h} req</span>
                </div>
            </div>
        `).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <h2 style="margin:0 0 24px;font-size:22px;font-weight:700;letter-spacing:-.02em">Dashboard Overview</h2>
            <div data-banner-container>${alertBanner}</div>
            <div class="stat-grid">${statCards}</div>

            <div class="card" style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
                    <h3 style="margin:0;font-size:15px;font-weight:700">Token Usage</h3>
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                        <div id="chart-nav-controls">${navControlsHtml()}</div>
                        <div class="tab-bar">
                            <button class="tab-btn ${currentPeriod === 'daily' ? 'active' : ''}" onclick="switchPeriod('daily')">Day</button>
                            <button class="tab-btn ${currentPeriod === 'weekly' ? 'active' : ''}" onclick="switchPeriod('weekly')">Week</button>
                            <button class="tab-btn ${currentPeriod === 'monthly' ? 'active' : ''}" onclick="switchPeriod('monthly')">Month</button>
                        </div>
                    </div>
                </div>
                <div style="height:240px"><canvas id="tokenChart"></canvas></div>
            </div>

            <div class="card" style="margin-bottom:28px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0;font-size:15px;font-weight:700">Requests by Service</h3>
                    <span style="font-size:12px;color:var(--text-dim)">LLM completions + API calls</span>
                </div>
                <div style="height:200px"><canvas id="serviceChart"></canvas></div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="card">
                    <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Request Distribution (24h)</h3>
                    <div style="height:180px"><canvas id="pieChart"></canvas></div>
                    <div id="pie-legend" style="display:flex;justify-content:center;gap:20px;margin-top:8px;flex-wrap:wrap"></div>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Connection Health</h3>
                    <div style="display:flex;flex-direction:column;gap:10px">${healthRows}</div>
                </div>
            </div>
        </div>
    `;

    renderTokenChart();
    renderServiceChart();
    renderPieChart();
}

// ============================================================
// CHARTS
// ============================================================

function _getChartData(chartType) {
    // chartType: 'token' or 'service'
    // Returns {labels, datasets, isArea} for the current period + nav state
    const key = _usageCacheKey(currentPeriod, currentNavDate);
    const cached = usageData[key];
    const raw = cached ? (cached.data || cached) : [];  // new format has .data; legacy daily is array

    const providerColors = { ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa', openrouter: '#a78bfa', getlate: '#fbbf24', lmstudio: '#34d399', custom: '#8899aa' };
    const serviceColors = { ...providerColors, github: '#e2e8f0', late: '#fbbf24', getlate: '#fbbf24', elevenlabs: '#f472b6', kie: '#38bdf8', sora: '#fb923c', gitlab: '#fb923c' };
    const colorMap = chartType === 'token' ? providerColors : serviceColors;

    const isMonthArea = currentPeriod === 'monthly';

    // Build labels
    let labels;
    if (currentPeriod === 'weekly') {
        labels = raw.map(d => d.label || d.date); // Mon/Tue/...
    } else if (currentPeriod === 'monthly') {
        // Show every 5th day to avoid clutter
        labels = raw.map(d => {
            const day = parseInt(d.date.slice(8));
            return (day === 1 || day % 5 === 0) ? String(day) : '';
        });
    } else {
        // Daily (30-day trend) ‚Äî show date labels
        labels = raw.map(d => d.date ? d.date.slice(5) : d.week || d.month || '');
    }

    // Collect all keys
    const dataKey = chartType === 'token' ? 'by_provider' : 'requests_by_service';
    const keys = [...new Set(raw.flatMap(d => Object.keys(d[dataKey] || {})))];

    const baseOpts = (color) => isMonthArea ? {
        fill: true,
        backgroundColor: color.replace(')', ', 0.7)').replace('rgb', 'rgba').replace('#', '').slice(0,0) || color + 'b3',
        borderColor: color,
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 4,
        stack: 'stacked',
    } : {
        backgroundColor: color,
        stack: chartType === 'token' ? 'tokens' : 'reqs',
    };

    const hexToRgba = (hex, alpha) => {
        const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        return `rgba(${r},${g},${b},${alpha})`;
    };

    const datasets = keys.map(k => {
        const rawColor = colorMap[k] || '#8899aa';
        const color = isMonthArea ? hexToRgba(rawColor.startsWith('#') ? rawColor : '#8899aa', 0.75) : rawColor;
        const borderCol = rawColor.startsWith('#') ? rawColor : '#8899aa';
        return {
            label: k.charAt(0).toUpperCase() + k.slice(1),
            data: raw.map(d => (d[dataKey] || {})[k] || 0),
            ...(isMonthArea ? { fill: true, backgroundColor: color, borderColor: borderCol, borderWidth: 2, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 } : { backgroundColor: borderCol }),
            stack: chartType === 'token' ? 'tokens' : 'reqs',
        };
    });

    if (datasets.length === 0) {
        datasets.push({ label: 'No data', data: [], backgroundColor: '#1e2d3d', stack: 'stacked' });
    }

    return { labels, datasets, isArea: isMonthArea };
}

function renderTokenChart() {
    const canvas = document.getElementById('tokenChart');
    if (!canvas) return;
    if (tokenChart) { tokenChart.destroy(); tokenChart = null; }

    const { labels, datasets, isArea } = _getChartData('token');
    const tooltipLabel = ctx => `${ctx.dataset.label}: ${ctx.raw.toLocaleString()} tokens`;

    tokenChart = new Chart(canvas, {
        type: isArea ? 'line' : 'bar',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#8899aa', font: { size: 12 } } },
                tooltip: { backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8, callbacks: { label: tooltipLabel } }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { color: '#1e2d3d' } },
                y: { stacked: true, ticks: { color: '#556677', font: { size: 11 }, callback: v => formatNum(v) }, grid: { color: '#1e2d3d' }, border: { display: false } }
            }
        }
    });
}

function renderServiceChart() {
    const canvas = document.getElementById('serviceChart');
    if (!canvas) return;
    if (serviceChart) { serviceChart.destroy(); serviceChart = null; }

    const { labels, datasets, isArea } = _getChartData('service');
    const tooltipLabel = ctx => `${ctx.dataset.label}: ${ctx.raw.toLocaleString()} requests`;

    serviceChart = new Chart(canvas, {
        type: isArea ? 'line' : 'bar',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#8899aa', font: { size: 12 } } },
                tooltip: { backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8, callbacks: { label: tooltipLabel } }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { color: '#1e2d3d' } },
                y: { stacked: true, ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { display: false } }
            }
        }
    });
}

function renderPieChart() {
    const canvas = document.getElementById('pieChart');
    if (!canvas) return;
    if (pieChart) { pieChart.destroy(); pieChart = null; }

    const byProvider = {};
    connectionsData.forEach(conn => {
        const key = conn.service === 'sora' ? 'openai' : conn.service;
        byProvider[key] = (byProvider[key] || 0) + (conn.requests_24h || 0);
    });

    const provColorMap = { ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa' };
    const entries = Object.entries(byProvider).filter(([, v]) => v > 0);

    if (entries.length === 0) {
        // Draw empty state text on canvas
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.fillStyle = '#556677';
        ctx.font = '13px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No request data', canvas.width / 2, canvas.height / 2);
        return;
    }

    const labels = entries.map(([k]) => k.charAt(0).toUpperCase() + k.slice(1));
    const values = entries.map(([, v]) => v);
    const colors = entries.map(([k]) => provColorMap[k] || '#8899aa');

    pieChart = new Chart(canvas, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: { backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8 }
            }
        }
    });

    const legend = document.getElementById('pie-legend');
    if (legend) {
        legend.innerHTML = labels.map((l, i) => `
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)">
                <span style="width:8px;height:8px;border-radius:2px;background:${colors[i]};flex-shrink:0"></span>${l}: ${values[i]}
            </div>
        `).join('');
    }
}

async function switchPeriod(period) {
    currentPeriod = period;
    currentNavDate = null; // reset to current period when switching tabs
    await loadUsage(period, null);
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const text = btn.textContent.trim().toLowerCase();
        btn.classList.toggle('active',
            (period === 'daily' && text === 'day') ||
            (period === 'weekly' && text === 'week') ||
            (period === 'monthly' && text === 'month')
        );
    });
    renderChartArea();
}

function renderChartArea() {
    // Re-render nav controls + both charts without re-rendering the full overview.
    // Updates the nav controls container and redraws token + service charts.
    const navEl = document.getElementById('chart-nav-controls');
    if (navEl) navEl.innerHTML = navControlsHtml();
    renderTokenChart();
    renderServiceChart();
}

// ============================================================
// VIEW: ACTIVITY
// ============================================================

function renderActivity() {
    // Merge LLM completions + non-LLM API calls into one chronological feed
    const llmRows = requestsData.map(r => ({ ...r, _type: 'llm' }));
    const apiRows = apiCallsData.map(r => ({ ...r, _type: 'api' }));
    const combined = [...llmRows, ...apiRows].sort((a, b) => {
        const ta = new Date(a.created_at || 0).getTime();
        const tb = new Date(b.created_at || 0).getTime();
        return tb - ta; // newest first
    });

    const rows = combined.length === 0
        ? `<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text-dim)">No activity recorded yet</td></tr>`
        : combined.map(r => {
            const latencyColor = (r.latency_ms || 0) > 2000 ? 'color:var(--yellow)' : 'color:var(--text-muted)';

            if (r._type === 'llm') {
                const statusHtml = r.status === 'success'
                    ? `<span style="color:var(--green);display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600">${ICONS.check} OK</span>`
                    : `<span style="color:var(--red);display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600">${ICONS.x} ERR</span>`;
                return `<tr>
                    <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;color:var(--text-dim)">${formatTime(r.created_at)}</td>
                    <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;font-weight:500">${r.model || '‚Äî'}</td>
                    <td style="padding:12px 16px;text-align:right">${serviceBadge(r.provider || 'custom')}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${(r.prompt_tokens || 0).toLocaleString()}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${(r.completion_tokens || 0).toLocaleString()}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${formatCost(r.cost_usd)}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace;${latencyColor}">${r.status === 'error' ? '‚Äî' : formatLatency(r.latency_ms)}</td>
                    <td style="padding:12px 16px;text-align:right">${statusHtml}</td>
                </tr>`;
            } else {
                // Non-LLM API call row
                const sc = r.status_code || 0;
                const scColor = sc >= 500 ? 'var(--red)' : sc >= 400 ? 'var(--yellow)' : 'var(--green)';
                const statusHtml = sc
                    ? `<span style="color:${scColor};font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace">${sc}</span>`
                    : `<span style="color:var(--text-dim);font-size:12px">‚Äî</span>`;
                return `<tr style="opacity:0.9">
                    <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;color:var(--text-dim)">${formatTime(r.created_at)}</td>
                    <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;font-weight:500;color:var(--text-muted)">${r.operation || '‚Äî'}</td>
                    <td style="padding:12px 16px;text-align:right">${serviceBadge(r.service || 'custom')}</td>
                    <td style="padding:12px 16px;text-align:right;color:var(--text-dim);font-size:12px" colspan="2">${(r.method || 'GET')} ${r.endpoint || ''}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${formatCost(r.cost_usd)}</td>
                    <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace;${latencyColor}">${formatLatency(r.latency_ms)}</td>
                    <td style="padding:12px 16px;text-align:right">${statusHtml}</td>
                </tr>`;
            }
        }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div data-banner-container>${allBannersHtml()}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Recent Activity</h2>
                <div style="display:flex;align-items:center;gap:12px">
                    <span style="font-size:12px;color:var(--text-dim)">${llmRows.length} LLM ¬∑ ${apiRows.length} API calls</span>
                    <button class="btn btn-ghost btn-sm" onclick="refreshActivity()">${ICONS.refresh} Refresh</button>
                </div>
            </div>
            <div class="card" style="padding:0;overflow:hidden">
                <table class="data-table">
                    <thead><tr style="background:var(--surface-alt)">
                        <th style="text-align:left">Time</th>
                        <th style="text-align:left">Model / Operation</th>
                        <th style="text-align:right">Service</th>
                        <th style="text-align:right" colspan="2">Details</th>
                        <th style="text-align:right">Cost</th>
                        <th style="text-align:right">Latency</th>
                        <th style="text-align:right">Status</th>
                    </tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>
    `;
}

async function refreshActivity() {
    await Promise.all([loadRequests(50), loadApiCalls(50)]);
    renderActivity();
}

// ============================================================
// VIEW: CONNECTIONS
// ============================================================

function renderConnections() {
    const infoBanner = `<div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--accent-dim);border:1px solid rgba(34,211,238,0.2);border-radius:8px;margin-bottom:20px;font-size:13px;color:var(--text-muted)">
        <span style="color:var(--accent);flex-shrink:0">${ICONS.alert}</span>
        LLM provider changes require a Hub restart to take effect. Non-LLM service connections (ElevenLabs, GitHub, etc.) are available immediately via the API.
    </div>`;

    const cards = connectionsData.length === 0
        ? `<div style="text-align:center;padding:64px;color:var(--text-dim)">
              <div style="margin-bottom:16px;font-size:32px">üîå</div>
              <div style="font-size:16px;font-weight:600;margin-bottom:8px;color:var(--text-muted)">No connections configured</div>
              <div style="font-size:13px;margin-bottom:24px">Add a connection to start monitoring providers</div>
              <button class="btn btn-primary" onclick="openAddConnectionModal()">${ICONS.plus} Add Connection</button>
           </div>`
        : connectionsData.map(conn => {
            const tpl = SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom;
            const color = tpl.color;
            const opacity = conn.enabled ? 1 : 0.5;
            const borderColor = conn.enabled ? (conn.status === 'degraded' ? 'rgba(251,191,36,0.4)' : 'var(--border)') : 'var(--border)';

            const credFields = [];
            if (conn.api_key_masked) credFields.push({ label: 'API Key', value: conn.api_key_masked });
            if (conn.token_masked) credFields.push({ label: 'Token / PAT', value: conn.token_masked });
            if (conn.cred_path) credFields.push({ label: 'Credentials', value: conn.cred_path });
            if (credFields.length === 0) credFields.push({ label: 'Auth', value: 'None required', noMask: true });

            const metaCols = [
                { label: 'Latency', value: `<span class="mono" style="font-size:18px;font-weight:700;color:${(conn.latency_avg_ms || 0) > 2000 ? 'var(--yellow)' : 'var(--text)'}">${formatLatency(conn.latency_avg_ms)}</span>` },
                { label: 'Requests (24h)', value: `<span class="mono" style="font-size:18px;font-weight:700">${conn.requests_24h || 0}</span>` },
                { label: 'Errors (24h)', value: `<span class="mono" style="font-size:18px;font-weight:700;color:${(conn.errors_24h || 0) > 0 ? 'var(--red)' : 'var(--green)'}">${conn.errors_24h || 0}</span>` },
                ...credFields.map(cf => ({
                    label: cf.label,
                    value: cf.noMask
                        ? `<span style="font-size:13px;color:var(--green)">${cf.value}</span>`
                        : `<span class="mono" style="font-size:13px;color:var(--text-muted)">${cf.value}</span>`
                }))
            ];

            const totalCols = metaCols.length;

            // Budget status for card
            const budgetBlocked = conn.budget_blocked;
            const overrideActive = conn.budget_override_active;
            const cardBorderColor = budgetBlocked
                ? 'rgba(248,113,113,0.45)'
                : overrideActive
                ? 'rgba(251,191,36,0.4)'
                : borderColor;

            // Budget row ‚Äî only show when at least one limit is set
            const hasBudgets = conn.daily_limit_usd != null || conn.weekly_limit_usd != null || conn.monthly_limit_usd != null;
            const budgetRowHtml = hasBudgets ? (() => {
                const periods = [
                    { label: 'Daily', spent: conn.daily_spent_usd || 0, limit: conn.daily_limit_usd },
                    { label: 'Weekly', spent: conn.weekly_spent_usd || 0, limit: conn.weekly_limit_usd },
                    { label: 'Monthly', spent: conn.monthly_spent_usd || 0, limit: conn.monthly_limit_usd },
                ];
                const budgetCells = periods.map(p => {
                    if (p.limit == null) return `<div><div style="font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">${p.label} Budget</div><span style="color:var(--text-dim);font-size:13px">No limit</span></div>`;
                    const pct = p.limit > 0 ? Math.min(p.spent / p.limit * 100, 100) : 0;
                    const col = pct >= 100 ? 'var(--red)' : pct >= 70 ? 'var(--yellow)' : 'var(--green)';
                    return `<div>
                        <div style="font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">${p.label} Budget</div>
                        <div class="mono" style="font-size:15px;font-weight:700;color:${col}">$${p.spent.toFixed(2)} / $${p.limit.toFixed(2)}</div>
                        <div style="height:4px;background:var(--surface-alt);border-radius:2px;margin-top:6px">
                            <div style="height:100%;width:${pct}%;background:${col};border-radius:2px;transition:width .5s"></div>
                        </div>
                    </div>`;
                }).join('');
                const statusBadge = budgetBlocked
                    ? `<span style="font-size:11px;font-weight:700;color:var(--red);background:var(--red-dim);padding:3px 10px;border-radius:4px;animation:pulse 2s infinite">‚õî BUDGET BLOCKED</span>`
                    : overrideActive
                    ? `<span style="font-size:11px;font-weight:700;color:var(--yellow);background:var(--yellow-dim);padding:3px 10px;border-radius:4px">‚ö†Ô∏è OVERRIDE</span>`
                    : '';
                const resumeBtn = budgetBlocked
                    ? `<button class="btn btn-sm" style="background:var(--red);color:white" onclick="confirmBudgetOverride(${conn.id})">Resume</button>`
                    : '';
                return `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:12px;color:var(--text-dim);font-weight:600">Budget</span>
                            ${statusBadge}
                        </div>
                        <div style="display:flex;gap:8px">
                            ${resumeBtn}
                            <button class="btn btn-ghost btn-sm" onclick="openBudgetEditModal(${conn.id})">${ICONS.settings} Edit</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">${budgetCells}</div>
                </div>`;
            })() : '';

            return `<div class="card" style="opacity:${opacity};border-color:${cardBorderColor}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div style="display:flex;align-items:center;gap:14px">
                        <div style="width:44px;height:44px;border-radius:10px;background:${color}15;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            ${serviceIcon(conn.service, 20)}
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <span style="font-size:16px;font-weight:700">${conn.name}</span>
                                ${serviceBadge(conn.service)}
                                ${statusDot(conn.enabled ? conn.status : 'offline')}
                            </div>
                            <div class="mono" style="font-size:12px;color:var(--text-dim);margin-top:4px">${conn.base_url || '‚Äî'}</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;flex-shrink:0">
                        <button class="btn btn-ghost btn-sm" onclick="toggleConnection(${conn.id})">${conn.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="btn btn-ghost btn-sm" onclick="openEditConnectionModal(${conn.id})">${ICONS.edit} Edit</button>
                        <button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(248,113,113,0.4)" onclick="showDeleteConfirm(${conn.id})">${ICONS.trash}</button>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(${totalCols}, 1fr);gap:16px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                    ${metaCols.map(col => `
                        <div>
                            <div style="font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">${col.label}</div>
                            ${col.value}
                        </div>
                    `).join('')}
                </div>
                ${budgetRowHtml}
                ${pendingDeleteId === conn.id ? `
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px;padding:12px 16px;background:var(--red-dim);border:1px solid rgba(248,113,113,0.3);border-radius:8px">
                        <span style="font-size:13px;color:var(--red);font-weight:600">Remove ${conn.name}? This cannot be undone.</span>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-ghost btn-sm" onclick="showDeleteConfirm(${conn.id})">Cancel</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete(${conn.id})">${ICONS.trash} Remove</button>
                        </div>
                    </div>
                ` : ''}
            </div>`;
        }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div data-banner-container>${allBannersHtml()}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Connections</h2>
                <div style="display:flex;gap:10px">
                    <button class="btn btn-ghost" onclick="importFromEnv()">${ICONS.refresh} Import from .env</button>
                    <button class="btn btn-primary" onclick="openAddConnectionModal()">${ICONS.plus} Add Connection</button>
                </div>
            </div>
            ${infoBanner}
            <div style="display:flex;flex-direction:column;gap:16px">${cards}</div>
        </div>
    `;
}

async function importFromEnv() {
    try {
        showToast('Scanning .env for configured providers...', 'success', 2000);
        const res = await fetch('/api/dashboard/connections/import-env', { method: 'POST' });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Import failed', 'error');
            return;
        }

        // Refresh connections list
        await loadConnections();
        renderConnections();

        // Show result toast
        const type = data.imported.length > 0 ? 'success' : 'warning';
        showToast(data.message, type, 5000);
    } catch (e) {
        showToast('Import failed: ' + e.message, 'error');
    }
}

// ============================================================
// VIEW: COSTS
// ============================================================

function renderCosts() {
    // Build a map of connection_id ‚Üí connection for grouping
    const connMap = {};
    connectionsData.forEach(c => { connMap[c.id] = c; });

    // Group cost entries by connection_id (null = unlinked/legacy)
    const grouped = {};
    costsData.forEach(c => {
        const key = c.connection_id != null ? c.connection_id : '__unlinked__';
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(c);
    });

    // Build connection groups in order: linked connections first, then unlinked
    const orderedKeys = [
        ...connectionsData.map(c => c.id).filter(id => grouped[id]),
        ...Object.keys(grouped).filter(k => k === '__unlinked__' && grouped[k]),
    ];

    // If no connections configured yet, ensure we still show the add button
    if (orderedKeys.length === 0 && connectionsData.length === 0) {
        orderedKeys.push('__empty__');
    }

    function budgetBar(label, spent, limit) {
        if (limit == null) return `<span style="font-size:12px;color:var(--text-dim)">‚Äî</span>`;
        const pct = limit > 0 ? Math.min(spent / limit * 100, 100) : 0;
        const color = pct >= 100 ? 'var(--red)' : pct >= 70 ? 'var(--yellow)' : 'var(--green)';
        return `<span style="font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;color:${color}">$${spent.toFixed(2)}/$${limit.toFixed(2)} (${Math.round(pct)}%)</span>`;
    }

    const connectionGroups = orderedKeys.map(key => {
        if (key === '__empty__') {
            return `<div class="card" style="text-align:center;padding:48px 24px;color:var(--text-dim)">
                <div style="font-size:28px;margin-bottom:12px">üí∞</div>
                <div style="font-size:15px;font-weight:600;color:var(--text-muted);margin-bottom:8px">No cost configurations yet</div>
                <div style="font-size:13px;margin-bottom:20px">Add a connection first, or add a cost entry manually.</div>
                <button class="btn btn-primary btn-sm" onclick="openAddCostModal()">${ICONS.plus} Add Cost Entry</button>
            </div>`;
        }

        const entries = grouped[key] || [];
        let conn = key !== '__unlinked__' ? connMap[parseInt(key)] : null;
        const label = conn ? conn.name : 'Unlinked (Legacy)';
        const service = conn ? conn.service : (entries[0]?.provider || 'custom');
        const tplColor = (SERVICE_TEMPLATES[service] || SERVICE_TEMPLATES.custom).color;

        // Budget status from connection
        const budgetBlocked = conn && conn.budget_blocked;
        const overrideActive = conn && conn.budget_override_active;
        const dailyLimit = conn?.daily_limit_usd ?? null;
        const weeklyLimit = conn?.weekly_limit_usd ?? null;
        const monthlyLimit = conn?.monthly_limit_usd ?? null;
        const dailySpent = conn?.daily_spent_usd ?? 0;
        const weeklySpent = conn?.weekly_spent_usd ?? 0;
        const monthlySpent = conn?.monthly_spent_usd ?? 0;
        const resetsAt = conn?.budget_resets_at;

        // Status pill for header
        let statusPill = '';
        if (budgetBlocked) {
            const countdown = formatCountdown(resetsAt);
            statusPill = `<span style="font-size:11px;font-weight:700;color:var(--red);background:var(--red-dim);padding:3px 10px;border-radius:4px;border:1px solid rgba(248,113,113,0.3)">‚õî BLOCKED ¬∑ Resets in ${countdown}</span>`;
        } else if (overrideActive) {
            const countdown = formatCountdown(conn.budget_override_until);
            statusPill = `<span style="font-size:11px;font-weight:700;color:var(--yellow);background:var(--yellow-dim);padding:3px 10px;border-radius:4px;border:1px solid rgba(251,191,36,0.3)">‚ö†Ô∏è OVERRIDE ¬∑ Expires in ${countdown}</span>`;
        }

        const budgetCols = [
            { label: 'Daily', spent: dailySpent, limit: dailyLimit },
            { label: 'Weekly', spent: weeklySpent, limit: weeklyLimit },
            { label: 'Monthly', spent: monthlySpent, limit: monthlyLimit },
        ];

        const budgetDisplay = budgetCols.map(b =>
            `<div style="display:flex;align-items:center;gap:6px">
                <span style="font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.05em">${b.label}:</span>
                ${budgetBar(b.label, b.spent, b.limit)}
             </div>`
        ).join('');

        const costRows = entries.length === 0
            ? `<tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-dim);font-size:13px">No cost entries yet ‚Äî click + Add Cost Entry below</td></tr>`
            : entries.map(c => {
                const inputFmt = (!c.input_cost_per_million || c.input_cost_per_million === 0)
                    ? `<span style="color:var(--green)">FREE</span>`
                    : `<span class="mono">$${c.input_cost_per_million.toFixed(2)}</span>`;
                const outputFmt = (!c.output_cost_per_million || c.output_cost_per_million === 0)
                    ? `<span style="color:var(--green)">FREE</span>`
                    : `<span class="mono">$${c.output_cost_per_million.toFixed(2)}</span>`;
                return `<tr>
                    <td style="padding:10px 16px;font-family:'JetBrains Mono',monospace;font-weight:500;font-size:13px">${c.model}</td>
                    <td style="padding:10px 16px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:13px">${inputFmt}</td>
                    <td style="padding:10px 16px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:13px">${outputFmt}</td>
                    <td style="padding:10px 16px;text-align:right">
                        <button class="btn btn-ghost btn-sm" onclick="openCostEditModal(${c.id})" style="margin-right:4px">${ICONS.edit} Edit</button>
                        <button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="deleteCostEntry(${c.id},'${c.model}')">${ICONS.trash}</button>
                    </td>
                </tr>`;
            }).join('');

        const editBudgetBtn = conn
            ? `<button class="btn btn-ghost btn-sm" onclick="openBudgetEditModal(${conn.id})" style="flex-shrink:0">${ICONS.settings} Edit Budget</button>`
            : '';
        const resumeBtn = (budgetBlocked && conn)
            ? `<button class="btn btn-sm" style="background:var(--red);color:white;flex-shrink:0" onclick="confirmBudgetOverride(${conn.id})">Resume</button>`
            : '';

        const borderStyle = budgetBlocked
            ? 'border-color:rgba(248,113,113,0.4)'
            : overrideActive
            ? 'border-color:rgba(251,191,36,0.35)'
            : '';

        return `<div class="card" style="margin-bottom:12px;${borderStyle}">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                    <span style="font-size:15px;font-weight:700;color:${tplColor}">${label}</span>
                    ${serviceBadge(service)}
                    ${statusPill}
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    ${budgetDisplay}
                    ${editBudgetBtn}
                    ${resumeBtn}
                </div>
            </div>
            <div style="border-radius:8px;overflow:hidden;border:1px solid var(--border)">
                <table class="data-table" style="font-size:13px">
                    <thead><tr style="background:var(--surface-alt)">
                        <th style="text-align:left">Model</th>
                        <th style="text-align:right">Input / 1M</th>
                        <th style="text-align:right">Output / 1M</th>
                        <th style="text-align:right">Actions</th>
                    </tr></thead>
                    <tbody>${costRows}</tbody>
                </table>
            </div>
            <div style="margin-top:10px;text-align:right">
                <button class="btn btn-ghost btn-sm" onclick="openAddCostModal(${conn ? conn.id : 'null'}, '${service}')">${ICONS.plus} Add Cost Entry</button>
            </div>
        </div>`;
    }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div data-banner-container>${allBannersHtml()}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Cost Configuration</h2>
                <button class="btn btn-ghost btn-sm" onclick="openAddCostModal()">${ICONS.plus} Add Cost Entry</button>
            </div>
            ${connectionGroups}
            <div class="card" style="margin-top:8px">
                <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Estimated Cost Over Time</h3>
                <div style="height:240px"><canvas id="costChart"></canvas></div>
            </div>
        </div>
    `;

    renderCostChart();
}

function renderCostChart() {
    const canvas = document.getElementById('costChart');
    if (!canvas) return;
    if (costChart) { costChart.destroy(); costChart = null; }

    const raw = usageData['daily'] || [];
    const labels = raw.map(d => d.date);
    const values = raw.map(d => {
        const total = d.total || 0;
        return parseFloat((total / 1e6 * 1.0).toFixed(4));
    });

    costChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels,
            datasets: [{ label: 'Est. Cost', data: values, borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, fill: false }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1,
                    titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8,
                    callbacks: { label: ctx => `$${ctx.raw}` }
                }
            },
            scales: {
                x: { ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { color: '#1e2d3d' } },
                y: { ticks: { color: '#556677', font: { size: 11 }, callback: v => `$${v}` }, grid: { color: '#1e2d3d' }, border: { display: false } }
            }
        }
    });
}

// ============================================================
// COST EDIT MODAL
// ============================================================

function openCostEditModal(costId) {
    const cost = costsData.find(c => c.id === costId);
    if (!cost) return;

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Edit Cost Configuration</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div class="form-group">
            <label class="form-label">Model</label>
            <input class="form-input mono" type="text" value="${cost.model}" readonly style="opacity:0.6;cursor:not-allowed">
        </div>
        <div class="form-group">
            <label class="form-label">Provider</label>
            <input class="form-input" type="text" value="${cost.provider}" readonly style="opacity:0.6;cursor:not-allowed">
        </div>
        <div class="form-group">
            <label class="form-label">Input Cost (per 1M tokens, USD)</label>
            <input id="cost-input-val" class="form-input mono" type="number" step="0.01" min="0" value="${cost.input_cost_per_million}">
        </div>
        <div class="form-group">
            <label class="form-label">Output Cost (per 1M tokens, USD)</label>
            <input id="cost-output-val" class="form-input mono" type="number" step="0.01" min="0" value="${cost.output_cost_per_million}">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitCostEdit(${costId})">${ICONS.check} Save</button>
        </div>
    `);
}

async function submitCostEdit(costId) {
    const inputVal = parseFloat(document.getElementById('cost-input-val')?.value) || 0;
    const outputVal = parseFloat(document.getElementById('cost-output-val')?.value) || 0;

    try {
        const res = await fetch(`/api/dashboard/costs/${costId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input_cost_per_million: inputVal, output_cost_per_million: outputVal })
        });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Update failed', 'error'); return; }

        closeModal();
        await loadCosts();
        renderCosts();
        showToast('Cost configuration updated', 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// PER-CONNECTION BUDGET MODAL
// ============================================================

function openBudgetEditModal(connId) {
    const conn = connectionsData.find(c => c.id === connId);
    if (!conn) return;

    const val = (v) => v != null ? v : '';
    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Budget Limits ‚Äî ${conn.name}</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent-dim);border-radius:8px;font-size:12px;color:var(--accent);margin-bottom:16px">
            ${ICONS.alert} Leave a field blank to remove that limit. Requests will be blocked at 100% of any set limit.
        </div>
        <div class="form-group">
            <label class="form-label">Daily Budget (USD) ‚Äî resets at midnight UTC</label>
            <input id="bgt-daily" class="form-input mono" type="number" step="0.01" min="0" placeholder="No limit" value="${val(conn.daily_limit_usd)}">
        </div>
        <div class="form-group">
            <label class="form-label">Weekly Budget (USD) ‚Äî resets Monday midnight UTC</label>
            <input id="bgt-weekly" class="form-input mono" type="number" step="0.01" min="0" placeholder="No limit" value="${val(conn.weekly_limit_usd)}">
        </div>
        <div class="form-group">
            <label class="form-label">Monthly Budget (USD) ‚Äî resets 1st of month UTC</label>
            <input id="bgt-monthly" class="form-input mono" type="number" step="0.01" min="0" placeholder="No limit" value="${val(conn.monthly_limit_usd)}">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitBudgetEdit(${connId})">${ICONS.check} Save</button>
        </div>
    `);
}

async function submitBudgetEdit(connId) {
    const parseLimit = (id) => {
        const v = document.getElementById(id)?.value?.trim();
        if (!v) return -1; // empty = remove limit
        const n = parseFloat(v);
        return isNaN(n) ? -1 : n;
    };
    const daily = parseLimit('bgt-daily');
    const weekly = parseLimit('bgt-weekly');
    const monthly = parseLimit('bgt-monthly');

    try {
        const res = await fetch(`/api/dashboard/connections/${connId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ daily_limit_usd: daily, weekly_limit_usd: weekly, monthly_limit_usd: monthly })
        });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Update failed', 'error'); return; }

        closeModal();
        await Promise.all([loadConnections(), loadStats()]);
        renderCosts();
        showToast('Budget limits updated', 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// ADD COST ENTRY MODAL
// ============================================================

function openAddCostModal(connId = null, defaultProvider = '') {
    const connOptions = connectionsData.map(c =>
        `<option value="${c.id}" ${c.id === connId ? 'selected' : ''}>${c.name} (${c.service})</option>`
    ).join('');

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Add Cost Entry</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div class="form-group">
            <label class="form-label">Connection</label>
            <select id="cost-conn-id" class="form-input">
                <option value="">None / Unlinked</option>
                ${connOptions}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Model Name</label>
            <input id="cost-model" class="form-input mono" type="text" placeholder="e.g. gpt-4o" value="">
        </div>
        <div class="form-group">
            <label class="form-label">Provider</label>
            <input id="cost-provider" class="form-input" type="text" placeholder="e.g. openai" value="${defaultProvider}">
        </div>
        <div class="form-group">
            <label class="form-label">Input Cost (per 1M tokens, USD)</label>
            <input id="cost-input-new" class="form-input mono" type="number" step="0.01" min="0" value="0">
        </div>
        <div class="form-group">
            <label class="form-label">Output Cost (per 1M tokens, USD)</label>
            <input id="cost-output-new" class="form-input mono" type="number" step="0.01" min="0" value="0">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAddCost()">${ICONS.check} Add</button>
        </div>
    `);
    setTimeout(() => { document.getElementById('cost-model')?.focus(); }, 50);
}

async function submitAddCost() {
    const model = document.getElementById('cost-model')?.value?.trim();
    const provider = document.getElementById('cost-provider')?.value?.trim();
    const connIdRaw = document.getElementById('cost-conn-id')?.value;
    const connId = connIdRaw ? parseInt(connIdRaw) : null;
    const inputVal = parseFloat(document.getElementById('cost-input-new')?.value) || 0;
    const outputVal = parseFloat(document.getElementById('cost-output-new')?.value) || 0;

    if (!model) { showToast('Model name is required', 'error'); return; }
    if (!provider) { showToast('Provider is required', 'error'); return; }

    try {
        const res = await fetch('/api/dashboard/costs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model, provider,
                connection_id: connId,
                input_cost_per_million: inputVal,
                output_cost_per_million: outputVal
            })
        });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Create failed', 'error'); return; }

        closeModal();
        await loadCosts();
        renderCosts();
        showToast('Cost entry added', 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// DELETE COST ENTRY
// ============================================================

let _pendingDeleteCostId = null;

async function deleteCostEntry(costId, modelName) {
    if (_pendingDeleteCostId === costId) {
        // Second click ‚Äî confirm delete
        _pendingDeleteCostId = null;
        try {
            const res = await fetch(`/api/dashboard/costs/${costId}`, { method: 'DELETE' });
            if (!res.ok) { showToast('Delete failed', 'error'); return; }
            await loadCosts();
            renderCosts();
            showToast(`Cost entry for '${modelName}' removed`, 'success');
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        }
        return;
    }
    // First click ‚Äî arm for confirmation
    _pendingDeleteCostId = costId;
    showToast(`Click delete again to confirm removing '${modelName}'`, 'warning', 4000);
    setTimeout(() => { if (_pendingDeleteCostId === costId) _pendingDeleteCostId = null; }, 4000);
}

// ============================================================
// BUDGET OVERRIDE (RESUME)
// ============================================================

function confirmBudgetOverride(connId) {
    const conn = connectionsData.find(c => c.id === connId);
    if (!conn) return;

    const reason = conn.budget_blocked_reason || 'budget';
    const spent = conn[`${reason}_spent_usd`] || 0;
    const limit = conn[`${reason}_limit_usd`] || 0;

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700;color:var(--red)">Resume ${conn.name}?</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="padding:14px 16px;background:var(--red-dim);border:1px solid rgba(248,113,113,0.3);border-radius:8px;margin-bottom:16px;font-size:13px;color:var(--red)">
            This connection has exceeded its ${reason} budget ($${spent.toFixed(2)} / $${limit.toFixed(2)}). Resuming will allow requests until the current period resets.
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;font-size:13px">
            <input type="checkbox" id="override-confirm" onchange="document.getElementById('override-btn').disabled=!this.checked" style="width:16px;height:16px;cursor:pointer">
            <label for="override-confirm" style="cursor:pointer;color:var(--text-muted)">I understand this will exceed my budget</label>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button id="override-btn" class="btn btn-danger" disabled onclick="submitBudgetOverride(${connId})">Resume</button>
        </div>
    `);
}

async function submitBudgetOverride(connId) {
    try {
        const res = await fetch(`/api/dashboard/connections/${connId}/budget-override`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Override failed', 'error'); return; }

        closeModal();
        await Promise.all([loadConnections(), loadStats()]);
        renderCosts();
        showToast('Budget override active. Enforcement resumes at ' + (data.override_until || 'next reset'), 'success', 6000);
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// TOAST
// ============================================================

function showToast(message, type = 'success', durationMs = 4000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = type;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, durationMs);
}

// ============================================================
// MODAL
// ============================================================

let currentModal = null;

function openModal(contentHtml, width = 520) {
    const overlay = document.getElementById('modal-overlay');
    overlay.innerHTML = `
        <div class="modal-box" style="width:${width}px" onclick="event.stopPropagation()">
            ${contentHtml}
        </div>
    `;
    overlay.classList.add('open');
    overlay.onclick = closeModal;
    currentModal = overlay;

    document._modalEscHandler = (e) => { if (e.key === 'Escape') closeModal(); };
    document.addEventListener('keydown', document._modalEscHandler);
}

function closeModal() {
    const overlay = document.getElementById('modal-overlay');
    overlay.classList.remove('open');
    overlay.innerHTML = '';
    if (document._modalEscHandler) {
        document.removeEventListener('keydown', document._modalEscHandler);
        document._modalEscHandler = null;
    }
}

// ============================================================
// ADD CONNECTION ‚Äî TWO-STEP MODAL
// ============================================================

let addStep = 'pick'; // 'pick' | 'configure'
let selectedServiceKey = null;
let customFieldToggles = { baseUrl: true, apiKey: true, token: false, credPath: false };

function openAddConnectionModal() {
    addStep = 'pick';
    selectedServiceKey = null;
    renderAddModalPick('');
}

function renderAddModalPick(searchQuery) {
    const lq = searchQuery.toLowerCase();

    const grouped = {};
    Object.entries(SERVICE_TEMPLATES).forEach(([key, tpl]) => {
        if (!lq || tpl.name.toLowerCase().includes(lq) || tpl.category.toLowerCase().includes(lq) || key.includes(lq)) {
            if (!grouped[tpl.category]) grouped[tpl.category] = [];
            grouped[tpl.category].push({ key, ...tpl });
        }
    });

    const categories = CATEGORY_ORDER.filter(cat => grouped[cat]);

    const categoryHtml = categories.map(cat => {
        const items = grouped[cat].map(svc => `
            <div onclick="selectServiceTemplate('${svc.key}')" style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s"
                onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--surface-alt)';this.style.transform='translateY(-1px)'"
                onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface)';this.style.transform='none'">
                <div style="width:36px;height:36px;border-radius:8px;background:${svc.color}15;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:${svc.color}">
                    ${(SERVICE_ICONS[svc.icon] || ICONS.server)}
                </div>
                <div style="min-width:0">
                    <div style="font-size:13px;font-weight:700;color:var(--text)">${svc.name}</div>
                    <div style="font-size:11px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${svc.hint.split('‚Äî')[0].trim()}</div>
                </div>
            </div>
        `).join('');

        return `<div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;padding-left:2px">${cat}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">${items}</div>
        </div>`;
    }).join('');

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Add Connection</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="position:relative;margin-bottom:20px">
            <span style="position:absolute;left:12px;top:11px;color:var(--text-dim)">${ICONS.search}</span>
            <input id="svc-search" type="text" placeholder="Search services..." value="${searchQuery}"
                oninput="renderAddModalPick(this.value)"
                style="width:100%;background:var(--surface-alt);border:1px solid var(--border);border-radius:8px;padding:10px 14px 10px 38px;color:var(--text);font-size:14px;outline:none;font-family:inherit">
        </div>
        <div style="display:flex;flex-direction:column;gap:20px;max-height:55vh;overflow-y:auto;padding-right:4px">
            ${categoryHtml}
        </div>
    `, 640);

    setTimeout(() => { const el = document.getElementById('svc-search'); if (el) el.focus(); }, 50);
}

function selectServiceTemplate(serviceKey) {
    selectedServiceKey = serviceKey;
    addStep = 'configure';
    customFieldToggles = { baseUrl: true, apiKey: true, token: false, credPath: false };
    renderAddModalConfigure();
}

function renderAddModalConfigure() {
    const tpl = SERVICE_TEMPLATES[selectedServiceKey];
    const isCustom = selectedServiceKey === 'custom';
    const color = tpl.color;

    const showField = (f) => isCustom ? customFieldToggles[f] : tpl.fields[f];

    const customToggles = isCustom ? `
        <div style="margin-bottom:8px">
            <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Credential Fields Needed</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                ${[
                    {key:'baseUrl',label:'Base URL'},
                    {key:'apiKey',label:'API Key'},
                    {key:'token',label:'Token / PAT'},
                    {key:'credPath',label:'Credentials File'},
                ].map(f => `<button onclick="toggleCustomField('${f.key}')" id="toggle-${f.key}"
                    style="padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${customFieldToggles[f.key] ? 'var(--accent)' : 'var(--border)'};background:${customFieldToggles[f.key] ? 'var(--accent-dim)' : 'transparent'};color:${customFieldToggles[f.key] ? 'var(--accent)' : 'var(--text-muted)'};transition:all .15s">
                    ${f.label}
                </button>`).join('')}
            </div>
        </div>
    ` : '';

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Configure ${tpl.name}</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:${color}10;border:1px solid ${color}25;border-radius:10px;margin-bottom:16px">
            <span style="color:${color}">${(SERVICE_ICONS[tpl.icon]||ICONS.server)}</span>
            <div>
                <div style="font-size:13px;font-weight:700;color:${color}">${tpl.name}</div>
                <div style="font-size:11px;color:var(--text-dim)">${tpl.hint}</div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Connection Name</label>
            <input id="conn-name" class="form-input" type="text" placeholder="e.g. Production OpenAI" value="${isCustom ? '' : tpl.name}">
        </div>
        ${customToggles}
        <div id="dynamic-fields">
            ${buildDynamicFields(tpl, isCustom)}
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent-dim);border-radius:8px;font-size:12px;color:var(--accent);margin-bottom:16px">
            ${ICONS.refresh} Hub will save this connection to local storage.
        </div>
        <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px">
            <button class="btn btn-ghost" onclick="renderAddModalPick('')">‚Üê Back</button>
            <div style="display:flex;gap:10px">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddConnection()">${ICONS.check} Add Connection</button>
            </div>
        </div>
    `);
}

function buildDynamicFields(tpl, isCustom) {
    const showField = (f) => isCustom ? customFieldToggles[f] : tpl.fields[f];
    const tokenPlaceholder = selectedServiceKey === 'github' ? 'ghp_...' : selectedServiceKey === 'gitlab' ? 'glpat-...' : 'token...';

    return `
        ${showField('baseUrl') ? `
        <div class="form-group">
            <label class="form-label">Base URL</label>
            <input id="conn-base-url" class="form-input mono" type="text" placeholder="${tpl.defaults.baseUrl || 'https://api.example.com/v1'}" value="${tpl.defaults.baseUrl || ''}">
        </div>` : ''}
        ${showField('apiKey') ? `
        <div class="form-group">
            <label class="form-label">API Key</label>
            <input id="conn-api-key" class="form-input mono" type="password" placeholder="sk-...">
            <span class="form-hint">Stored locally, encrypted at rest</span>
        </div>` : ''}
        ${showField('token') ? `
        <div class="form-group">
            <label class="form-label">Token / Personal Access Token</label>
            <input id="conn-token" class="form-input mono" type="password" placeholder="${tokenPlaceholder}">
        </div>` : ''}
        ${showField('credPath') ? `
        <div class="form-group">
            <label class="form-label">Credentials File Path</label>
            <input id="conn-cred-path" class="form-input mono" type="text" placeholder="/path/to/credentials.json">
            <span class="form-hint">Absolute path to the credentials file on the Hub host</span>
        </div>` : ''}
    `;
}

function toggleCustomField(fieldKey) {
    customFieldToggles[fieldKey] = !customFieldToggles[fieldKey];
    document.getElementById('dynamic-fields').innerHTML = buildDynamicFields(SERVICE_TEMPLATES[selectedServiceKey], true);
    const btn = document.getElementById(`toggle-${fieldKey}`);
    if (btn) {
        const active = customFieldToggles[fieldKey];
        btn.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
        btn.style.background = active ? 'var(--accent-dim)' : 'transparent';
        btn.style.color = active ? 'var(--accent)' : 'var(--text-muted)';
    }
}

async function submitAddConnection() {
    const name = document.getElementById('conn-name')?.value?.trim();
    if (!name) { showToast('Connection name is required', 'error'); return; }

    const tpl = SERVICE_TEMPLATES[selectedServiceKey];

    const body = {
        name,
        service: selectedServiceKey,
        category: tpl.category,
        base_url: document.getElementById('conn-base-url')?.value || tpl.defaults.baseUrl || '',
        api_key: document.getElementById('conn-api-key')?.value || '',
        token: document.getElementById('conn-token')?.value || '',
        cred_path: document.getElementById('conn-cred-path')?.value || '',
    };

    try {
        const res = await fetch('/api/dashboard/connections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Failed to create connection', 'error');
            return;
        }

        closeModal();
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// EDIT CONNECTION MODAL
// ============================================================

async function openEditConnectionModal(connId) {
    const conn = connectionsData.find(c => c.id === connId);
    if (!conn) return;

    const tpl = SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom;
    const color = tpl.color;

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Edit ${conn.name}</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${color}10;border:1px solid ${color}25;border-radius:10px;margin-bottom:16px">
            <span style="color:${color}">${(SERVICE_ICONS[tpl.icon]||ICONS.server)}</span>
            <span style="font-size:12px;font-weight:700;color:${color}">${tpl.category}</span>
        </div>
        <div class="form-group">
            <label class="form-label">Connection Name</label>
            <input id="edit-name" class="form-input" type="text" value="${conn.name}">
        </div>
        ${tpl.fields.baseUrl ? `<div class="form-group">
            <label class="form-label">Base URL</label>
            <input id="edit-base-url" class="form-input mono" type="text" value="${conn.base_url || ''}">
        </div>` : ''}
        ${tpl.fields.apiKey ? `<div class="form-group">
            <label class="form-label">Update API Key</label>
            <input id="edit-api-key" class="form-input mono" type="password" placeholder="Enter new key to replace current (leave blank to keep)">
            <span class="form-hint">Current: ${conn.api_key_masked || '(none)'}</span>
        </div>` : ''}
        ${tpl.fields.token ? `<div class="form-group">
            <label class="form-label">Update Token / PAT</label>
            <input id="edit-token" class="form-input mono" type="password" placeholder="Enter new token to replace current (leave blank to keep)">
            <span class="form-hint">Current: ${conn.token_masked || '(none)'}</span>
        </div>` : ''}
        ${tpl.fields.credPath ? `<div class="form-group">
            <label class="form-label">Credentials File Path</label>
            <input id="edit-cred-path" class="form-input mono" type="text" value="${conn.cred_path || ''}">
        </div>` : ''}
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--yellow-dim);border-radius:8px;font-size:12px;color:var(--yellow);margin-bottom:16px">
            ${ICONS.alert} Changing credentials will update the stored value. LLM provider changes require a Hub restart.
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitEditConnection(${connId})">${ICONS.check} Save Changes</button>
        </div>
    `);
}

async function submitEditConnection(connId) {
    const body = {};
    const nameEl = document.getElementById('edit-name');
    const baseUrlEl = document.getElementById('edit-base-url');
    const apiKeyEl = document.getElementById('edit-api-key');
    const tokenEl = document.getElementById('edit-token');
    const credPathEl = document.getElementById('edit-cred-path');

    if (nameEl) body.name = nameEl.value.trim();
    if (baseUrlEl) body.base_url = baseUrlEl.value;
    if (apiKeyEl) body.api_key = apiKeyEl.value;
    if (tokenEl) body.token = tokenEl.value;
    if (credPathEl) body.cred_path = credPathEl.value;

    try {
        const res = await fetch(`/api/dashboard/connections/${connId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Failed to update connection', 'error');
            return;
        }

        closeModal();
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// DELETE CONFIRMATION + TOGGLE
// ============================================================

let pendingDeleteId = null;

function showDeleteConfirm(connId) {
    if (pendingDeleteId === connId) {
        pendingDeleteId = null;
    } else {
        pendingDeleteId = connId;
    }
    renderConnections();
}

async function confirmDelete(connId) {
    try {
        const res = await fetch(`/api/dashboard/connections/${connId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Delete failed', 'error'); return; }
        pendingDeleteId = null;
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

async function toggleConnection(connId) {
    try {
        const res = await fetch(`/api/dashboard/connections/${connId}/toggle`, { method: 'PATCH' });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Toggle failed', 'error'); return; }
        await loadConnections();
        renderConnections();
        showToast(data.message, 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// NAVIGATION
// ============================================================

const NAV_ITEMS = [
    { key: 'overview',    icon: ICONS.barChart, label: 'Overview' },
    { key: 'connections', icon: ICONS.server,   label: 'Connections' },
    { key: 'costs',       icon: ICONS.dollar,   label: 'Costs' },
    { key: 'activity',   icon: ICONS.list,     label: 'Activity' },
];

function renderSidebar() {
    const nav = document.getElementById('sidebar');
    nav.innerHTML = NAV_ITEMS.map(item => `
        <button class="nav-btn ${currentView === item.key ? 'active' : ''}" onclick="showView('${item.key}')" data-view="${item.key}">
            ${item.icon} ${item.label}
        </button>
    `).join('') + `
        <div style="flex:1"></div>
        <div id="sidebar-footer">
            <div class="mono" style="font-size:11px;color:var(--text-dim)">v1.0.0</div>
            <div style="font-size:11px;color:var(--text-dim)">Apache 2.0</div>
        </div>
    `;
}

async function showView(view) {
    currentView = view;
    renderSidebar();
    await refreshView(view);
}

async function refreshView(view) {
    if (view === 'overview') {
        await Promise.all([loadStats(), loadUsage(currentPeriod, currentNavDate), loadConnections(), loadActiveAlerts()]);
        renderOverview();
    } else if (view === 'connections') {
        await loadConnections();
        renderConnections();
    } else if (view === 'costs') {
        await Promise.all([loadStats(), loadBudget(), loadCosts(), loadUsage('daily', null)]);
        renderCosts();
    } else if (view === 'activity') {
        await Promise.all([loadRequests(50), loadApiCalls(50)]);
        renderActivity();
    }
}

// ============================================================
// HEADER
// ============================================================

function renderHeader() {
    const active = connectionsData.filter(c => c.enabled).length;
    const total = connectionsData.length;
    const el = document.getElementById('header-conn-count');
    if (el) el.textContent = `${active} of ${total} active`;
}

// ============================================================
// INIT
// ============================================================

document.addEventListener('DOMContentLoaded', async () => {
    renderSidebar();
    await Promise.all([loadStats(), loadUsage('daily', null), loadConnections(), loadRequests(50), loadApiCalls(50), loadActiveAlerts()]);
    renderHeader();
    renderOverview();

    // Poll for active alerts every 30 seconds ‚Äî updates banners on next view render
    setInterval(async () => {
        await loadActiveAlerts();
        // If currently on a view that renders banners, re-render the banner area in-place
        // without a full view reload (avoids chart flicker)
        const bannerContainers = document.querySelectorAll('[data-banner-container]');
        if (bannerContainers.length > 0) {
            bannerContainers.forEach(el => { el.innerHTML = allBannersHtml(); });
        }
    }, 30000);
});
    </script>
</body>
</html>

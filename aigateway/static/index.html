<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Hub Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0e17;
            --surface: #111827;
            --surface-alt: #1a2332;
            --border: #1e2d3d;
            --border-light: #2a3a4d;
            --text: #e2e8f0;
            --text-muted: #8899aa;
            --text-dim: #556677;
            --accent: #22d3ee;
            --accent-dim: rgba(34, 211, 238, 0.12);
            --green: #34d399;
            --green-dim: rgba(52, 211, 153, 0.12);
            --yellow: #fbbf24;
            --yellow-dim: rgba(251, 191, 36, 0.12);
            --red: #f87171;
            --red-dim: rgba(248, 113, 113, 0.12);
            --purple: #a78bfa;
            --purple-dim: rgba(167, 139, 250, 0.12);
            --pink: #f472b6;
            --orange: #fb923c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        header {
            height: 65px;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Layout */
        #app-body { display: flex; min-height: calc(100vh - 65px); }

        /* Sidebar */
        nav#sidebar {
            width: 200px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.15s;
            text-align: left;
            width: 100%;
        }
        .nav-btn:hover { background: var(--surface-alt); }
        .nav-btn.active { background: var(--accent-dim); color: var(--accent); }

        /* Main content */
        main#content {
            flex: 1;
            padding: 28px;
            overflow-y: auto;
            max-height: calc(100vh - 65px);
        }

        /* Views */
        .view { animation: fadeIn 0.3s ease-out; }

        /* Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        /* Stat grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        @media (max-width: 1200px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }

        /* Buttons */
        .btn {
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            padding: 10px 18px;
            font-size: 14px;
        }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-danger { background: var(--red); color: white; }
        .btn:disabled { opacity: 0.4; cursor: default; }

        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 2px;
            background: var(--surface-alt);
            border-radius: 8px;
            padding: 3px;
        }
        .tab-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            letter-spacing: 0.03em;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent); color: var(--bg); }

        /* Status dot */
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Mono font helper */
        .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            padding: 10px 16px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--surface-alt);
        }
        .data-table td { padding: 12px 16px; border-top: 1px solid var(--border); }
        .data-table tr:hover td { background: var(--surface-alt); }

        /* Modal */
        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        #modal-overlay.open { display: flex; }
        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            width: 520px;
            max-width: 92vw;
            max-height: 88vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Input */
        .form-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 16px; }
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .form-input {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            font-family: inherit;
            width: 100%;
        }
        .form-input:focus { border-color: var(--accent); }
        .form-hint { font-size: 11px; color: var(--text-dim); }

        /* Sidebar footer */
        #sidebar-footer {
            margin-top: auto;
            padding: 12px 14px;
            border-top: 1px solid var(--border);
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            z-index: 2000;
            display: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            max-width: 380px;
            line-height: 1.4;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
        }
        #toast.success { background: var(--green-dim); border: 1px solid rgba(52,211,153,0.3); color: var(--green); }
        #toast.warning { background: var(--yellow-dim); border: 1px solid rgba(251,191,36,0.3); color: var(--yellow); }
        #toast.error { background: var(--red-dim); border: 1px solid rgba(248,113,113,0.3); color: var(--red); }
    </style>
</head>
<body>
    <header>
        <div style="display:flex;align-items:center;gap:14px">
            <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#22d3ee,#a78bfa);display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(34,211,238,0.3);color:#0a0e17">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div>
                <div style="font-size:16px;font-weight:700;letter-spacing:-.02em">OpenClaw Hub</div>
                <div style="font-size:11px;color:var(--text-dim);font-family:'JetBrains Mono',monospace">127.0.0.1:8080</div>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:16px">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--green)">
                <span style="width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)"></span>
                <span id="header-conn-count">â€” active</span>
            </div>
        </div>
    </header>

    <div id="app-body">
        <nav id="sidebar"></nav>
        <main id="content">
            <div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--text-dim)">Loading...</div>
        </main>
    </div>

    <div id="modal-overlay"></div>
    <div id="toast"></div>

    <script>
// ============================================================
// CONSTANTS
// ============================================================

const COLORS = {
    bg: '#0a0e17', surface: '#111827', surfaceAlt: '#1a2332',
    border: '#1e2d3d', text: '#e2e8f0', textMuted: '#8899aa', textDim: '#556677',
    accent: '#22d3ee', accentDim: 'rgba(34,211,238,0.12)',
    green: '#34d399', greenDim: 'rgba(52,211,153,0.12)',
    yellow: '#fbbf24', yellowDim: 'rgba(251,191,36,0.12)',
    red: '#f87171', redDim: 'rgba(248,113,113,0.12)',
    purple: '#a78bfa', purpleDim: 'rgba(167,139,250,0.12)',
    pink: '#f472b6', orange: '#fb923c'
};

const PROVIDER_COLORS = {
    ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa',
    elevenlabs: '#f472b6', github: '#e2e8f0', sora: '#fb923c',
    kie: '#38bdf8', openrouter: '#a78bfa', getlate: '#fbbf24',
    lmstudio: '#34d399', google: '#34d399', gitlab: '#fb923c', custom: '#8899aa'
};

const ICONS = {
    shield: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
    barChart: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
    server: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="7" cy="6" r="1" fill="currentColor"/><circle cx="7" cy="18" r="1" fill="currentColor"/></svg>`,
    dollar: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
    list: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    zap: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
    activity: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
    plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
    refresh: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
    x: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
    check: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
    alert: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
    lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    settings: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
    hardDrive: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="12" x2="2" y2="12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><circle cx="12" cy="17" r="1" fill="currentColor"/></svg>`,
    cloud: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
    mic: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>`,
    video: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
    gitBranch: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>`,
    globe: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
    fileText: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
    trash: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`,
    edit: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
    eye: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`,
    eyeOff: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`,
    search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
};

const SERVICE_ICONS = {
    HardDrive: ICONS.hardDrive, Cloud: ICONS.cloud, Mic: ICONS.mic,
    Video: ICONS.video, GitBranch: ICONS.gitBranch, Globe: ICONS.globe,
    FileText: ICONS.fileText, Settings: ICONS.settings, Server: ICONS.server,
};

const SERVICE_TEMPLATES = {
    ollama:     { name: "Ollama (Local)",        category: "LLM (Local)",    icon: "HardDrive", color: "#34d399", fields: { baseUrl: true, apiKey: false, token: false, credPath: false }, defaults: { baseUrl: "http://127.0.0.1:11434" }, hint: "Local inference server â€” no authentication required" },
    openai:     { name: "OpenAI",                category: "LLM",            icon: "Cloud",     color: "#22d3ee", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.openai.com/v1" }, hint: "Requires an API key from platform.openai.com" },
    anthropic:  { name: "Anthropic",             category: "LLM",            icon: "Cloud",     color: "#a78bfa", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.anthropic.com/v1" }, hint: "Requires an API key from console.anthropic.com" },
    elevenlabs: { name: "ElevenLabs",            category: "Media / Audio",  icon: "Mic",       color: "#f472b6", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.elevenlabs.io/v1" }, hint: "Text-to-speech and voice cloning API" },
    sora:       { name: "Sora 2 (OpenAI)",       category: "Media / Video",  icon: "Video",     color: "#fb923c", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.openai.com/v1" }, hint: "Uses your OpenAI API key â€” video generation endpoints" },
    kie:        { name: "Kie.ai",                category: "Media / Video",  icon: "Video",     color: "#38bdf8", fields: { baseUrl: false, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.kie.ai" }, hint: "Cost-effective video generation â€” $0.24/5s" },
    github:     { name: "GitHub",                category: "Git / DevOps",   icon: "GitBranch", color: "#e2e8f0", fields: { baseUrl: false, apiKey: false, token: true,  credPath: false }, defaults: { baseUrl: "https://api.github.com" }, hint: "Personal Access Token with repo + workflow scopes" },
    gitlab:     { name: "GitLab",                category: "Git / DevOps",   icon: "GitBranch", color: "#fb923c", fields: { baseUrl: true, apiKey: false, token: true,  credPath: false }, defaults: { baseUrl: "https://gitlab.com/api/v4" }, hint: "PAT or project token â€” self-hosted instances need custom URL" },
    google:     { name: "Google (Drive/Sheets)", category: "Data",           icon: "FileText",  color: "#34d399", fields: { baseUrl: false, apiKey: false, token: false, credPath: true  }, defaults: { baseUrl: "" }, hint: "Path to service account credentials JSON file" },
    openrouter: { name: "OpenRouter",            category: "Gateway",        icon: "Globe",     color: "#a78bfa", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://openrouter.ai/api/v1" }, hint: "Multi-model gateway â€” drop-in OpenAI compatible" },
    getlate:    { name: "getlate.dev",           category: "Gateway",        icon: "Globe",     color: "#fbbf24", fields: { baseUrl: true, apiKey: true,  token: false, credPath: false }, defaults: { baseUrl: "https://api.getlate.dev/v1" }, hint: "API gateway with rate limiting and caching" },
    lmstudio:   { name: "LM Studio",             category: "LLM (Local)",    icon: "HardDrive", color: "#34d399", fields: { baseUrl: true, apiKey: false, token: false, credPath: false }, defaults: { baseUrl: "http://127.0.0.1:1234/v1" }, hint: "Local model server â€” OpenAI-compatible API" },
    custom:     { name: "Custom Service",        category: "Custom",         icon: "Settings",  color: "#8899aa", fields: { baseUrl: true, apiKey: true,  token: true,  credPath: true  }, defaults: { baseUrl: "" }, hint: "Configure any service â€” enable only the fields you need" },
};

const CATEGORY_ORDER = ["LLM", "LLM (Local)", "Media / Audio", "Media / Video", "Git / DevOps", "Data", "Gateway", "Custom"];

// ============================================================
// STATE
// ============================================================

let currentView = 'overview';
let currentPeriod = 'daily';

let statsData = null;
let usageData = {};
let connectionsData = [];
let requestsData = [];
let costsData = [];
let budgetData = null;

let tokenChart = null;
let pieChart = null;
let costChart = null;

// ============================================================
// API FUNCTIONS
// ============================================================

async function apiFetch(url) {
    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
    } catch (e) {
        console.error(`API error ${url}:`, e);
        return null;
    }
}

async function loadStats() {
    statsData = await apiFetch('/api/dashboard/stats');
}

async function loadUsage(period) {
    if (!usageData[period]) {
        const data = await apiFetch(`/api/dashboard/usage?period=${period}`);
        if (data) usageData[period] = data.data;
    }
}

async function loadConnections() {
    const data = await apiFetch('/api/dashboard/connections');
    if (data) connectionsData = data.connections;
}

async function loadRequests(limit = 50) {
    const data = await apiFetch(`/api/dashboard/requests?limit=${limit}`);
    if (data) requestsData = data.requests;
}

async function loadCosts() {
    const data = await apiFetch('/api/dashboard/costs');
    if (data) costsData = data.costs;
}

async function loadBudget() {
    budgetData = await apiFetch('/api/dashboard/budget');
}

// ============================================================
// HELPERS
// ============================================================

function formatNum(n) {
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(0) + 'k';
    return String(n);
}

function formatLatency(ms) {
    if (!ms) return 'â€”';
    if (ms > 10000) return (ms / 1000).toFixed(1) + 's';
    return ms + 'ms';
}

function formatCost(usd) {
    if (!usd || usd === 0) return '<span style="color:var(--green)">FREE</span>';
    return '<span style="color:var(--yellow)">$' + usd.toFixed(4) + '</span>';
}

function formatTime(isoStr) {
    if (!isoStr) return 'â€”';
    const d = new Date(isoStr);
    return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function statusDot(status) {
    const colors = { healthy: '#34d399', degraded: '#fbbf24', error: '#f87171', offline: '#556677', unknown: '#556677' };
    const color = colors[status] || colors.unknown;
    const pulse = (status !== 'healthy' && status !== 'offline') ? 'animation:pulse 2s infinite;' : '';
    return `<span style="display:inline-flex;align-items:center;gap:6px">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};box-shadow:0 0 8px ${color}60;${pulse}display:inline-block;flex-shrink:0"></span>
        <span style="color:${color};font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">${status}</span>
    </span>`;
}

function serviceBadge(service) {
    const tpl = SERVICE_TEMPLATES[service] || SERVICE_TEMPLATES.custom;
    const color = tpl.color;
    return `<span style="display:inline-flex;align-items:center;font-size:11px;font-weight:700;color:${color};background:${color}18;padding:2px 8px;border-radius:4px;letter-spacing:.04em">${tpl.category}</span>`;
}

function serviceIcon(service, size = 16) {
    const tpl = SERVICE_TEMPLATES[service] || SERVICE_TEMPLATES.custom;
    const iconSvg = SERVICE_ICONS[tpl.icon] || ICONS.server;
    const color = tpl.color;
    return iconSvg
        .replace(/width="\d+"/, `width="${size}"`)
        .replace(/height="\d+"/, `height="${size}"`)
        .replace('currentColor', color);
}

// ============================================================
// VIEW: OVERVIEW
// ============================================================

function renderOverview() {
    const s = statsData || {};
    const budget = s.budget || {};
    const tokens = s.tokens_today || 0;
    const reqs = s.requests_24h || 0;
    const errors = s.errors_24h || 0;
    const cost = s.estimated_daily_cost_usd || 0;
    const active = s.active_connections || 0;
    const total = s.total_connections || 0;
    const dailyPct = budget.daily_pct || 0;

    let alertBanner = '';
    if (dailyPct > 70) {
        const isRed = dailyPct > 90;
        const color = isRed ? '#f87171' : '#fbbf24';
        const bg = isRed ? 'var(--red-dim)' : 'var(--yellow-dim)';
        const border = isRed ? 'rgba(248,113,113,0.3)' : 'rgba(251,191,36,0.3)';
        alertBanner = `<div style="display:flex;align-items:center;gap:12px;padding:12px 18px;background:${bg};border:1px solid ${border};border-radius:10px;margin-bottom:20px">
            <span style="color:${color}">${ICONS.alert}</span>
            <span style="font-size:13px;color:${color};font-weight:600">Daily budget ${Math.round(dailyPct)}% used â€” $${cost.toFixed(2)} of $${(budget.daily_limit || 5).toFixed(2)} limit</span>
        </div>`;
    }

    const statCards = [
        { icon: ICONS.zap,      label: 'Tokens Today',    value: formatNum(tokens),      sub: 'Across all providers',              color: '#22d3ee' },
        { icon: ICONS.activity, label: 'Requests (24h)',  value: reqs.toLocaleString(),  sub: `${errors} errors`,                  color: '#34d399' },
        { icon: ICONS.dollar,   label: 'Est. Daily Cost', value: '$' + cost.toFixed(2),  sub: `Budget: $${budget.daily_limit || 5}`, color: '#fbbf24' },
        { icon: ICONS.server,   label: 'Connections',     value: String(active),         sub: `${total} configured`,               color: '#a78bfa' },
    ].map(({ icon, label, value, sub, color }) => `
        <div class="card" style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;align-items:center;gap:8px">
                <div style="width:32px;height:32px;border-radius:8px;background:${color}15;display:flex;align-items:center;justify-content:center;color:${color}">${icon}</div>
                <span style="font-size:12px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.06em">${label}</span>
            </div>
            <div class="mono" style="font-size:28px;font-weight:700;color:var(--text);letter-spacing:-.02em">${value}</div>
            <div style="font-size:12px;color:var(--text-dim)">${sub}</div>
        </div>
    `).join('');

    const healthRows = connectionsData.length === 0
        ? `<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:16px">No connections configured</div>`
        : connectionsData.map(conn => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface-alt);border-radius:8px;opacity:${conn.enabled ? 1 : 0.4}">
                <div style="display:flex;align-items:center;gap:10px">
                    <span style="color:${(SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom).color}">${serviceIcon(conn.service, 14)}</span>
                    <span style="font-size:13px;font-weight:600">${conn.name}</span>
                    ${statusDot(conn.enabled ? conn.status : 'offline')}
                </div>
                <div style="display:flex;align-items:center;gap:14px;font-size:12px;color:var(--text-dim)">
                    <span class="mono">${formatLatency(conn.latency_avg_ms)}</span>
                    <span>${conn.requests_24h} req</span>
                </div>
            </div>
        `).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <h2 style="margin:0 0 24px;font-size:22px;font-weight:700;letter-spacing:-.02em">Dashboard Overview</h2>
            ${alertBanner}
            <div class="stat-grid">${statCards}</div>

            <div class="card" style="margin-bottom:28px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                    <h3 style="margin:0;font-size:15px;font-weight:700">Token Usage</h3>
                    <div class="tab-bar">
                        <button class="tab-btn ${currentPeriod === 'daily' ? 'active' : ''}" onclick="switchPeriod('daily')">Day</button>
                        <button class="tab-btn ${currentPeriod === 'weekly' ? 'active' : ''}" onclick="switchPeriod('weekly')">Week</button>
                        <button class="tab-btn ${currentPeriod === 'monthly' ? 'active' : ''}" onclick="switchPeriod('monthly')">Month</button>
                    </div>
                </div>
                <div style="height:280px"><canvas id="tokenChart"></canvas></div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="card">
                    <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Request Distribution (24h)</h3>
                    <div style="height:180px"><canvas id="pieChart"></canvas></div>
                    <div id="pie-legend" style="display:flex;justify-content:center;gap:20px;margin-top:8px;flex-wrap:wrap"></div>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Connection Health</h3>
                    <div style="display:flex;flex-direction:column;gap:10px">${healthRows}</div>
                </div>
            </div>
        </div>
    `;

    renderTokenChart();
    renderPieChart();
}

// ============================================================
// CHARTS
// ============================================================

function renderTokenChart() {
    const canvas = document.getElementById('tokenChart');
    if (!canvas) return;
    if (tokenChart) { tokenChart.destroy(); tokenChart = null; }

    const raw = usageData[currentPeriod] || [];
    const providers = [...new Set(raw.flatMap(d => Object.keys(d.by_provider || {})))];
    const dateKey = currentPeriod === 'daily' ? 'date' : currentPeriod === 'weekly' ? 'week' : 'month';
    const labels = raw.map(d => d[dateKey]);

    const providerColors = { ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa' };
    const datasets = providers.map(p => ({
        label: p.charAt(0).toUpperCase() + p.slice(1),
        data: raw.map(d => (d.by_provider || {})[p] || 0),
        backgroundColor: providerColors[p] || '#8899aa',
        stack: 'tokens',
    }));

    // If no data at all, show empty placeholder dataset
    if (datasets.length === 0) {
        datasets.push({
            label: 'No data',
            data: [],
            backgroundColor: '#1e2d3d',
            stack: 'tokens',
        });
    }

    tokenChart = new Chart(canvas, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#8899aa', font: { size: 12 } } },
                tooltip: {
                    backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1,
                    titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8,
                    callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw.toLocaleString()} tokens` }
                }
            },
            scales: {
                x: { stacked: true, ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { color: '#1e2d3d' } },
                y: { stacked: true, ticks: { color: '#556677', font: { size: 11 }, callback: v => formatNum(v) }, grid: { color: '#1e2d3d' }, border: { display: false } }
            }
        }
    });
}

function renderPieChart() {
    const canvas = document.getElementById('pieChart');
    if (!canvas) return;
    if (pieChart) { pieChart.destroy(); pieChart = null; }

    const byProvider = {};
    connectionsData.forEach(conn => {
        const key = conn.service === 'sora' ? 'openai' : conn.service;
        byProvider[key] = (byProvider[key] || 0) + (conn.requests_24h || 0);
    });

    const provColorMap = { ollama: '#34d399', openai: '#22d3ee', anthropic: '#a78bfa' };
    const entries = Object.entries(byProvider).filter(([, v]) => v > 0);

    if (entries.length === 0) {
        // Draw empty state text on canvas
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.fillStyle = '#556677';
        ctx.font = '13px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('No request data', canvas.width / 2, canvas.height / 2);
        return;
    }

    const labels = entries.map(([k]) => k.charAt(0).toUpperCase() + k.slice(1));
    const values = entries.map(([, v]) => v);
    const colors = entries.map(([k]) => provColorMap[k] || '#8899aa');

    pieChart = new Chart(canvas, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: { display: false },
                tooltip: { backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1, titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8 }
            }
        }
    });

    const legend = document.getElementById('pie-legend');
    if (legend) {
        legend.innerHTML = labels.map((l, i) => `
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted)">
                <span style="width:8px;height:8px;border-radius:2px;background:${colors[i]};flex-shrink:0"></span>${l}: ${values[i]}
            </div>
        `).join('');
    }
}

async function switchPeriod(period) {
    currentPeriod = period;
    await loadUsage(period);
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const text = btn.textContent.trim().toLowerCase();
        btn.classList.toggle('active',
            (period === 'daily' && text === 'day') ||
            (period === 'weekly' && text === 'week') ||
            (period === 'monthly' && text === 'month')
        );
    });
    renderTokenChart();
}

// ============================================================
// VIEW: ACTIVITY
// ============================================================

function renderActivity() {
    const rows = requestsData.length === 0
        ? `<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text-dim)">No requests recorded yet</td></tr>`
        : requestsData.map(r => {
            const statusHtml = r.status === 'success'
                ? `<span style="color:var(--green);display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600">${ICONS.check} OK</span>`
                : `<span style="color:var(--red);display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:600">${ICONS.x} ERR</span>`;
            const latencyColor = r.latency_ms > 2000 ? 'color:var(--yellow)' : 'color:var(--text-muted)';
            return `<tr>
                <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;color:var(--text-dim)">${formatTime(r.created_at)}</td>
                <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;font-weight:500">${r.model || 'â€”'}</td>
                <td style="padding:12px 16px;text-align:right">${serviceBadge(r.provider || 'custom')}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${(r.prompt_tokens || 0).toLocaleString()}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${(r.completion_tokens || 0).toLocaleString()}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${formatCost(r.cost_usd)}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace;${latencyColor}">${r.status === 'error' ? 'â€”' : formatLatency(r.latency_ms)}</td>
                <td style="padding:12px 16px;text-align:right">${statusHtml}</td>
            </tr>`;
        }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Recent Activity</h2>
                <button class="btn btn-ghost btn-sm" onclick="refreshActivity()">${ICONS.refresh} Refresh</button>
            </div>
            <div class="card" style="padding:0;overflow:hidden">
                <table class="data-table">
                    <thead><tr style="background:var(--surface-alt)">
                        <th style="text-align:left">Time</th>
                        <th style="text-align:left">Model</th>
                        <th style="text-align:right">Service</th>
                        <th style="text-align:right">Prompt</th>
                        <th style="text-align:right">Completion</th>
                        <th style="text-align:right">Cost</th>
                        <th style="text-align:right">Latency</th>
                        <th style="text-align:right">Status</th>
                    </tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>
    `;
}

async function refreshActivity() {
    await loadRequests(50);
    renderActivity();
}

// ============================================================
// VIEW: CONNECTIONS
// ============================================================

function renderConnections() {
    const infoBanner = `<div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--accent-dim);border:1px solid rgba(34,211,238,0.2);border-radius:8px;margin-bottom:20px;font-size:13px;color:var(--text-muted)">
        <span style="color:var(--accent);flex-shrink:0">${ICONS.alert}</span>
        LLM provider changes require a Hub restart to take effect. Non-LLM service connections (ElevenLabs, GitHub, etc.) are available immediately via the API.
    </div>`;

    const cards = connectionsData.length === 0
        ? `<div style="text-align:center;padding:64px;color:var(--text-dim)">
              <div style="margin-bottom:16px;font-size:32px">ðŸ”Œ</div>
              <div style="font-size:16px;font-weight:600;margin-bottom:8px;color:var(--text-muted)">No connections configured</div>
              <div style="font-size:13px;margin-bottom:24px">Add a connection to start monitoring providers</div>
              <button class="btn btn-primary" onclick="openAddConnectionModal()">${ICONS.plus} Add Connection</button>
           </div>`
        : connectionsData.map(conn => {
            const tpl = SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom;
            const color = tpl.color;
            const opacity = conn.enabled ? 1 : 0.5;
            const borderColor = conn.enabled ? (conn.status === 'degraded' ? 'rgba(251,191,36,0.4)' : 'var(--border)') : 'var(--border)';

            const credFields = [];
            if (conn.api_key_masked) credFields.push({ label: 'API Key', value: conn.api_key_masked });
            if (conn.token_masked) credFields.push({ label: 'Token / PAT', value: conn.token_masked });
            if (conn.cred_path) credFields.push({ label: 'Credentials', value: conn.cred_path });
            if (credFields.length === 0) credFields.push({ label: 'Auth', value: 'None required', noMask: true });

            const metaCols = [
                { label: 'Latency', value: `<span class="mono" style="font-size:18px;font-weight:700;color:${(conn.latency_avg_ms || 0) > 2000 ? 'var(--yellow)' : 'var(--text)'}">${formatLatency(conn.latency_avg_ms)}</span>` },
                { label: 'Requests (24h)', value: `<span class="mono" style="font-size:18px;font-weight:700">${conn.requests_24h || 0}</span>` },
                { label: 'Errors (24h)', value: `<span class="mono" style="font-size:18px;font-weight:700;color:${(conn.errors_24h || 0) > 0 ? 'var(--red)' : 'var(--green)'}">${conn.errors_24h || 0}</span>` },
                ...credFields.map(cf => ({
                    label: cf.label,
                    value: cf.noMask
                        ? `<span style="font-size:13px;color:var(--green)">${cf.value}</span>`
                        : `<span class="mono" style="font-size:13px;color:var(--text-muted)">${cf.value}</span>`
                }))
            ];

            const totalCols = metaCols.length;

            return `<div class="card" style="opacity:${opacity};border-color:${borderColor}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div style="display:flex;align-items:center;gap:14px">
                        <div style="width:44px;height:44px;border-radius:10px;background:${color}15;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            ${serviceIcon(conn.service, 20)}
                        </div>
                        <div>
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <span style="font-size:16px;font-weight:700">${conn.name}</span>
                                ${serviceBadge(conn.service)}
                                ${statusDot(conn.enabled ? conn.status : 'offline')}
                            </div>
                            <div class="mono" style="font-size:12px;color:var(--text-dim);margin-top:4px">${conn.base_url || 'â€”'}</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;flex-shrink:0">
                        <button class="btn btn-ghost btn-sm" onclick="toggleConnection(${conn.id})">${conn.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="btn btn-ghost btn-sm" onclick="openEditConnectionModal(${conn.id})">${ICONS.edit} Edit</button>
                        <button class="btn btn-ghost btn-sm" style="color:var(--red);border-color:rgba(248,113,113,0.4)" onclick="showDeleteConfirm(${conn.id})">${ICONS.trash}</button>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(${totalCols}, 1fr);gap:16px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                    ${metaCols.map(col => `
                        <div>
                            <div style="font-size:11px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">${col.label}</div>
                            ${col.value}
                        </div>
                    `).join('')}
                </div>
                ${pendingDeleteId === conn.id ? `
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px;padding:12px 16px;background:var(--red-dim);border:1px solid rgba(248,113,113,0.3);border-radius:8px">
                        <span style="font-size:13px;color:var(--red);font-weight:600">Remove ${conn.name}? This cannot be undone.</span>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-ghost btn-sm" onclick="showDeleteConfirm(${conn.id})">Cancel</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete(${conn.id})">${ICONS.trash} Remove</button>
                        </div>
                    </div>
                ` : ''}
            </div>`;
        }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Connections</h2>
                <div style="display:flex;gap:10px">
                    <button class="btn btn-ghost" onclick="importFromEnv()">${ICONS.refresh} Import from .env</button>
                    <button class="btn btn-primary" onclick="openAddConnectionModal()">${ICONS.plus} Add Connection</button>
                </div>
            </div>
            ${infoBanner}
            <div style="display:flex;flex-direction:column;gap:16px">${cards}</div>
        </div>
    `;
}

async function importFromEnv() {
    try {
        showToast('Scanning .env for configured providers...', 'success', 2000);
        const res = await fetch('/api/dashboard/connections/import-env', { method: 'POST' });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Import failed', 'error');
            return;
        }

        // Refresh connections list
        await loadConnections();
        renderConnections();

        // Show result toast
        const type = data.imported.length > 0 ? 'success' : 'warning';
        showToast(data.message, type, 5000);
    } catch (e) {
        showToast('Import failed: ' + e.message, 'error');
    }
}

// ============================================================
// VIEW: COSTS
// ============================================================

function renderCosts() {
    const budget = budgetData || { daily_limit_usd: 5, weekly_limit_usd: 25, monthly_limit_usd: 80 };
    const stats = statsData || {};
    const dailySpent = stats.estimated_daily_cost_usd || 0;
    const weeklySpent = dailySpent * 7;
    const monthlySpent = dailySpent * 30;

    const budgetBars = [
        { label: 'Daily', limit: budget.daily_limit_usd, spent: dailySpent },
        { label: 'Weekly', limit: budget.weekly_limit_usd, spent: weeklySpent },
        { label: 'Monthly', limit: budget.monthly_limit_usd, spent: monthlySpent },
    ].map(b => {
        const pct = Math.min(b.limit > 0 ? (b.spent / b.limit * 100) : 0, 100);
        const color = pct > 90 ? 'var(--red)' : pct > 70 ? 'var(--yellow)' : 'var(--green)';
        return `<div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <span style="font-size:13px;font-weight:600;color:var(--text-muted)">${b.label} Budget</span>
                <span class="mono" style="font-size:12px;color:${color};font-weight:700">${Math.round(pct)}%</span>
            </div>
            <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:12px">
                <span class="mono" style="font-size:24px;font-weight:700">$${b.spent.toFixed(2)}</span>
                <span style="font-size:13px;color:var(--text-dim)">/ $${b.limit.toFixed(2)}</span>
            </div>
            <div style="height:6px;background:var(--surface-alt);border-radius:3px">
                <div style="height:100%;width:${pct}%;background:${color};border-radius:3px;transition:width .5s"></div>
            </div>
        </div>`;
    }).join('');

    const costRows = costsData.length === 0
        ? `<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--text-dim)">No cost configurations yet</td></tr>`
        : costsData.map(c => {
            const inputFmt = (!c.input_cost_per_million || c.input_cost_per_million === 0)
                ? `<span style="color:var(--green)">FREE</span>`
                : `$${c.input_cost_per_million.toFixed(2)}`;
            const outputFmt = (!c.output_cost_per_million || c.output_cost_per_million === 0)
                ? `<span style="color:var(--green)">FREE</span>`
                : `$${c.output_cost_per_million.toFixed(2)}`;
            return `<tr>
                <td style="padding:12px 16px;font-family:'JetBrains Mono',monospace;font-weight:500;text-align:left">${c.model}</td>
                <td style="padding:12px 16px;text-align:right">${serviceBadge(c.provider)}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${inputFmt}</td>
                <td style="padding:12px 16px;text-align:right;font-family:'JetBrains Mono',monospace">${outputFmt}</td>
                <td style="padding:12px 16px;text-align:right">
                    <button class="btn btn-ghost btn-sm" onclick="openCostEditModal(${c.id})">${ICONS.edit} Edit</button>
                </td>
            </tr>`;
        }).join('');

    document.getElementById('content').innerHTML = `
        <div class="view">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin:0;font-size:22px;font-weight:700;letter-spacing:-.02em">Cost Configuration</h2>
                <button class="btn btn-ghost btn-sm" onclick="openBudgetModal()">${ICONS.settings} Budget Limits</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px">${budgetBars}</div>
            <div class="card">
                <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Cost Per Token (per 1M tokens)</h3>
                <div style="border-radius:8px;overflow:hidden;border:1px solid var(--border)">
                    <table class="data-table">
                        <thead><tr style="background:var(--surface-alt)">
                            <th style="text-align:left">Model</th>
                            <th style="text-align:right">Provider</th>
                            <th style="text-align:right">Input Cost</th>
                            <th style="text-align:right">Output Cost</th>
                            <th style="text-align:right">Actions</th>
                        </tr></thead>
                        <tbody>${costRows}</tbody>
                    </table>
                </div>
            </div>
            <div class="card" style="margin-top:20px">
                <h3 style="margin:0 0 16px;font-size:15px;font-weight:700">Estimated Cost Over Time</h3>
                <div style="height:240px"><canvas id="costChart"></canvas></div>
            </div>
        </div>
    `;

    renderCostChart();
}

function renderCostChart() {
    const canvas = document.getElementById('costChart');
    if (!canvas) return;
    if (costChart) { costChart.destroy(); costChart = null; }

    const raw = usageData['daily'] || [];
    const labels = raw.map(d => d.date);
    const values = raw.map(d => {
        const total = d.total || 0;
        return parseFloat((total / 1e6 * 1.0).toFixed(4));
    });

    costChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels,
            datasets: [{ label: 'Est. Cost', data: values, borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, fill: false }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#111827', borderColor: '#1e2d3d', borderWidth: 1,
                    titleColor: '#e2e8f0', bodyColor: '#8899aa', cornerRadius: 8,
                    callbacks: { label: ctx => `$${ctx.raw}` }
                }
            },
            scales: {
                x: { ticks: { color: '#556677', font: { size: 11 } }, grid: { color: '#1e2d3d' }, border: { color: '#1e2d3d' } },
                y: { ticks: { color: '#556677', font: { size: 11 }, callback: v => `$${v}` }, grid: { color: '#1e2d3d' }, border: { display: false } }
            }
        }
    });
}

// ============================================================
// COST EDIT MODAL
// ============================================================

function openCostEditModal(costId) {
    const cost = costsData.find(c => c.id === costId);
    if (!cost) return;

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Edit Cost Configuration</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div class="form-group">
            <label class="form-label">Model</label>
            <input class="form-input mono" type="text" value="${cost.model}" readonly style="opacity:0.6;cursor:not-allowed">
        </div>
        <div class="form-group">
            <label class="form-label">Provider</label>
            <input class="form-input" type="text" value="${cost.provider}" readonly style="opacity:0.6;cursor:not-allowed">
        </div>
        <div class="form-group">
            <label class="form-label">Input Cost (per 1M tokens, USD)</label>
            <input id="cost-input-val" class="form-input mono" type="number" step="0.01" min="0" value="${cost.input_cost_per_million}">
        </div>
        <div class="form-group">
            <label class="form-label">Output Cost (per 1M tokens, USD)</label>
            <input id="cost-output-val" class="form-input mono" type="number" step="0.01" min="0" value="${cost.output_cost_per_million}">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitCostEdit(${costId})">${ICONS.check} Save</button>
        </div>
    `);
}

async function submitCostEdit(costId) {
    const inputVal = parseFloat(document.getElementById('cost-input-val')?.value) || 0;
    const outputVal = parseFloat(document.getElementById('cost-output-val')?.value) || 0;

    try {
        const res = await fetch(`/api/dashboard/costs/${costId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input_cost_per_million: inputVal, output_cost_per_million: outputVal })
        });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Update failed', 'error'); return; }

        closeModal();
        await loadCosts();
        renderCosts();
        showToast('Cost configuration updated', 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// BUDGET MODAL
// ============================================================

function openBudgetModal() {
    const b = budgetData || { daily_limit_usd: 5, weekly_limit_usd: 25, monthly_limit_usd: 80 };

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Budget Limits</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div class="form-group">
            <label class="form-label">Daily Budget (USD)</label>
            <input id="budget-daily" class="form-input mono" type="number" step="1" min="0" value="${b.daily_limit_usd}">
        </div>
        <div class="form-group">
            <label class="form-label">Weekly Budget (USD)</label>
            <input id="budget-weekly" class="form-input mono" type="number" step="1" min="0" value="${b.weekly_limit_usd}">
        </div>
        <div class="form-group">
            <label class="form-label">Monthly Budget (USD)</label>
            <input id="budget-monthly" class="form-input mono" type="number" step="1" min="0" value="${b.monthly_limit_usd}">
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent-dim);border-radius:8px;font-size:12px;color:var(--accent);margin-bottom:16px">
            ${ICONS.alert} Budget alerts appear on the Overview page when usage exceeds 70% of any limit.
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitBudget()">${ICONS.check} Save Limits</button>
        </div>
    `);
}

async function submitBudget() {
    const daily = parseFloat(document.getElementById('budget-daily')?.value) || 0;
    const weekly = parseFloat(document.getElementById('budget-weekly')?.value) || 0;
    const monthly = parseFloat(document.getElementById('budget-monthly')?.value) || 0;

    try {
        const res = await fetch('/api/dashboard/budget', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ daily_limit_usd: daily, weekly_limit_usd: weekly, monthly_limit_usd: monthly })
        });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Update failed', 'error'); return; }

        closeModal();
        budgetData = { daily_limit_usd: daily, weekly_limit_usd: weekly, monthly_limit_usd: monthly };
        await loadStats(); // refresh stats for updated budget percentages
        renderCosts();
        showToast('Budget limits updated', 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// TOAST
// ============================================================

function showToast(message, type = 'success', durationMs = 4000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = type;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, durationMs);
}

// ============================================================
// MODAL
// ============================================================

let currentModal = null;

function openModal(contentHtml, width = 520) {
    const overlay = document.getElementById('modal-overlay');
    overlay.innerHTML = `
        <div class="modal-box" style="width:${width}px" onclick="event.stopPropagation()">
            ${contentHtml}
        </div>
    `;
    overlay.classList.add('open');
    overlay.onclick = closeModal;
    currentModal = overlay;

    document._modalEscHandler = (e) => { if (e.key === 'Escape') closeModal(); };
    document.addEventListener('keydown', document._modalEscHandler);
}

function closeModal() {
    const overlay = document.getElementById('modal-overlay');
    overlay.classList.remove('open');
    overlay.innerHTML = '';
    if (document._modalEscHandler) {
        document.removeEventListener('keydown', document._modalEscHandler);
        document._modalEscHandler = null;
    }
}

// ============================================================
// ADD CONNECTION â€” TWO-STEP MODAL
// ============================================================

let addStep = 'pick'; // 'pick' | 'configure'
let selectedServiceKey = null;
let customFieldToggles = { baseUrl: true, apiKey: true, token: false, credPath: false };

function openAddConnectionModal() {
    addStep = 'pick';
    selectedServiceKey = null;
    renderAddModalPick('');
}

function renderAddModalPick(searchQuery) {
    const lq = searchQuery.toLowerCase();

    const grouped = {};
    Object.entries(SERVICE_TEMPLATES).forEach(([key, tpl]) => {
        if (!lq || tpl.name.toLowerCase().includes(lq) || tpl.category.toLowerCase().includes(lq) || key.includes(lq)) {
            if (!grouped[tpl.category]) grouped[tpl.category] = [];
            grouped[tpl.category].push({ key, ...tpl });
        }
    });

    const categories = CATEGORY_ORDER.filter(cat => grouped[cat]);

    const categoryHtml = categories.map(cat => {
        const items = grouped[cat].map(svc => `
            <div onclick="selectServiceTemplate('${svc.key}')" style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s"
                onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--surface-alt)';this.style.transform='translateY(-1px)'"
                onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface)';this.style.transform='none'">
                <div style="width:36px;height:36px;border-radius:8px;background:${svc.color}15;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:${svc.color}">
                    ${(SERVICE_ICONS[svc.icon] || ICONS.server)}
                </div>
                <div style="min-width:0">
                    <div style="font-size:13px;font-weight:700;color:var(--text)">${svc.name}</div>
                    <div style="font-size:11px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${svc.hint.split('â€”')[0].trim()}</div>
                </div>
            </div>
        `).join('');

        return `<div>
            <div style="font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;padding-left:2px">${cat}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">${items}</div>
        </div>`;
    }).join('');

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Add Connection</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="position:relative;margin-bottom:20px">
            <span style="position:absolute;left:12px;top:11px;color:var(--text-dim)">${ICONS.search}</span>
            <input id="svc-search" type="text" placeholder="Search services..." value="${searchQuery}"
                oninput="renderAddModalPick(this.value)"
                style="width:100%;background:var(--surface-alt);border:1px solid var(--border);border-radius:8px;padding:10px 14px 10px 38px;color:var(--text);font-size:14px;outline:none;font-family:inherit">
        </div>
        <div style="display:flex;flex-direction:column;gap:20px;max-height:55vh;overflow-y:auto;padding-right:4px">
            ${categoryHtml}
        </div>
    `, 640);

    setTimeout(() => { const el = document.getElementById('svc-search'); if (el) el.focus(); }, 50);
}

function selectServiceTemplate(serviceKey) {
    selectedServiceKey = serviceKey;
    addStep = 'configure';
    customFieldToggles = { baseUrl: true, apiKey: true, token: false, credPath: false };
    renderAddModalConfigure();
}

function renderAddModalConfigure() {
    const tpl = SERVICE_TEMPLATES[selectedServiceKey];
    const isCustom = selectedServiceKey === 'custom';
    const color = tpl.color;

    const showField = (f) => isCustom ? customFieldToggles[f] : tpl.fields[f];

    const customToggles = isCustom ? `
        <div style="margin-bottom:8px">
            <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Credential Fields Needed</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                ${[
                    {key:'baseUrl',label:'Base URL'},
                    {key:'apiKey',label:'API Key'},
                    {key:'token',label:'Token / PAT'},
                    {key:'credPath',label:'Credentials File'},
                ].map(f => `<button onclick="toggleCustomField('${f.key}')" id="toggle-${f.key}"
                    style="padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${customFieldToggles[f.key] ? 'var(--accent)' : 'var(--border)'};background:${customFieldToggles[f.key] ? 'var(--accent-dim)' : 'transparent'};color:${customFieldToggles[f.key] ? 'var(--accent)' : 'var(--text-muted)'};transition:all .15s">
                    ${f.label}
                </button>`).join('')}
            </div>
        </div>
    ` : '';

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Configure ${tpl.name}</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:${color}10;border:1px solid ${color}25;border-radius:10px;margin-bottom:16px">
            <span style="color:${color}">${(SERVICE_ICONS[tpl.icon]||ICONS.server)}</span>
            <div>
                <div style="font-size:13px;font-weight:700;color:${color}">${tpl.name}</div>
                <div style="font-size:11px;color:var(--text-dim)">${tpl.hint}</div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Connection Name</label>
            <input id="conn-name" class="form-input" type="text" placeholder="e.g. Production OpenAI" value="${isCustom ? '' : tpl.name}">
        </div>
        ${customToggles}
        <div id="dynamic-fields">
            ${buildDynamicFields(tpl, isCustom)}
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--accent-dim);border-radius:8px;font-size:12px;color:var(--accent);margin-bottom:16px">
            ${ICONS.refresh} Hub will save this connection to local storage.
        </div>
        <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px">
            <button class="btn btn-ghost" onclick="renderAddModalPick('')">â† Back</button>
            <div style="display:flex;gap:10px">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddConnection()">${ICONS.check} Add Connection</button>
            </div>
        </div>
    `);
}

function buildDynamicFields(tpl, isCustom) {
    const showField = (f) => isCustom ? customFieldToggles[f] : tpl.fields[f];
    const tokenPlaceholder = selectedServiceKey === 'github' ? 'ghp_...' : selectedServiceKey === 'gitlab' ? 'glpat-...' : 'token...';

    return `
        ${showField('baseUrl') ? `
        <div class="form-group">
            <label class="form-label">Base URL</label>
            <input id="conn-base-url" class="form-input mono" type="text" placeholder="${tpl.defaults.baseUrl || 'https://api.example.com/v1'}" value="${tpl.defaults.baseUrl || ''}">
        </div>` : ''}
        ${showField('apiKey') ? `
        <div class="form-group">
            <label class="form-label">API Key</label>
            <input id="conn-api-key" class="form-input mono" type="password" placeholder="sk-...">
            <span class="form-hint">Stored locally, encrypted at rest</span>
        </div>` : ''}
        ${showField('token') ? `
        <div class="form-group">
            <label class="form-label">Token / Personal Access Token</label>
            <input id="conn-token" class="form-input mono" type="password" placeholder="${tokenPlaceholder}">
        </div>` : ''}
        ${showField('credPath') ? `
        <div class="form-group">
            <label class="form-label">Credentials File Path</label>
            <input id="conn-cred-path" class="form-input mono" type="text" placeholder="/path/to/credentials.json">
            <span class="form-hint">Absolute path to the credentials file on the Hub host</span>
        </div>` : ''}
    `;
}

function toggleCustomField(fieldKey) {
    customFieldToggles[fieldKey] = !customFieldToggles[fieldKey];
    document.getElementById('dynamic-fields').innerHTML = buildDynamicFields(SERVICE_TEMPLATES[selectedServiceKey], true);
    const btn = document.getElementById(`toggle-${fieldKey}`);
    if (btn) {
        const active = customFieldToggles[fieldKey];
        btn.style.borderColor = active ? 'var(--accent)' : 'var(--border)';
        btn.style.background = active ? 'var(--accent-dim)' : 'transparent';
        btn.style.color = active ? 'var(--accent)' : 'var(--text-muted)';
    }
}

async function submitAddConnection() {
    const name = document.getElementById('conn-name')?.value?.trim();
    if (!name) { showToast('Connection name is required', 'error'); return; }

    const tpl = SERVICE_TEMPLATES[selectedServiceKey];

    const body = {
        name,
        service: selectedServiceKey,
        category: tpl.category,
        base_url: document.getElementById('conn-base-url')?.value || tpl.defaults.baseUrl || '',
        api_key: document.getElementById('conn-api-key')?.value || '',
        token: document.getElementById('conn-token')?.value || '',
        cred_path: document.getElementById('conn-cred-path')?.value || '',
    };

    try {
        const res = await fetch('/api/dashboard/connections', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Failed to create connection', 'error');
            return;
        }

        closeModal();
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// EDIT CONNECTION MODAL
// ============================================================

async function openEditConnectionModal(connId) {
    const conn = connectionsData.find(c => c.id === connId);
    if (!conn) return;

    const tpl = SERVICE_TEMPLATES[conn.service] || SERVICE_TEMPLATES.custom;
    const color = tpl.color;

    openModal(`
        <div class="modal-header">
            <h3 style="margin:0;font-size:18px;font-weight:700">Edit ${conn.name}</h3>
            <button onclick="closeModal()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px">${ICONS.x}</button>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${color}10;border:1px solid ${color}25;border-radius:10px;margin-bottom:16px">
            <span style="color:${color}">${(SERVICE_ICONS[tpl.icon]||ICONS.server)}</span>
            <span style="font-size:12px;font-weight:700;color:${color}">${tpl.category}</span>
        </div>
        <div class="form-group">
            <label class="form-label">Connection Name</label>
            <input id="edit-name" class="form-input" type="text" value="${conn.name}">
        </div>
        ${tpl.fields.baseUrl ? `<div class="form-group">
            <label class="form-label">Base URL</label>
            <input id="edit-base-url" class="form-input mono" type="text" value="${conn.base_url || ''}">
        </div>` : ''}
        ${tpl.fields.apiKey ? `<div class="form-group">
            <label class="form-label">Update API Key</label>
            <input id="edit-api-key" class="form-input mono" type="password" placeholder="Enter new key to replace current (leave blank to keep)">
            <span class="form-hint">Current: ${conn.api_key_masked || '(none)'}</span>
        </div>` : ''}
        ${tpl.fields.token ? `<div class="form-group">
            <label class="form-label">Update Token / PAT</label>
            <input id="edit-token" class="form-input mono" type="password" placeholder="Enter new token to replace current (leave blank to keep)">
            <span class="form-hint">Current: ${conn.token_masked || '(none)'}</span>
        </div>` : ''}
        ${tpl.fields.credPath ? `<div class="form-group">
            <label class="form-label">Credentials File Path</label>
            <input id="edit-cred-path" class="form-input mono" type="text" value="${conn.cred_path || ''}">
        </div>` : ''}
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--yellow-dim);border-radius:8px;font-size:12px;color:var(--yellow);margin-bottom:16px">
            ${ICONS.alert} Changing credentials will update the stored value. LLM provider changes require a Hub restart.
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitEditConnection(${connId})">${ICONS.check} Save Changes</button>
        </div>
    `);
}

async function submitEditConnection(connId) {
    const body = {};
    const nameEl = document.getElementById('edit-name');
    const baseUrlEl = document.getElementById('edit-base-url');
    const apiKeyEl = document.getElementById('edit-api-key');
    const tokenEl = document.getElementById('edit-token');
    const credPathEl = document.getElementById('edit-cred-path');

    if (nameEl) body.name = nameEl.value.trim();
    if (baseUrlEl) body.base_url = baseUrlEl.value;
    if (apiKeyEl) body.api_key = apiKeyEl.value;
    if (tokenEl) body.token = tokenEl.value;
    if (credPathEl) body.cred_path = credPathEl.value;

    try {
        const res = await fetch(`/api/dashboard/connections/${connId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        if (!res.ok) {
            showToast(data.detail || 'Failed to update connection', 'error');
            return;
        }

        closeModal();
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// DELETE CONFIRMATION + TOGGLE
// ============================================================

let pendingDeleteId = null;

function showDeleteConfirm(connId) {
    if (pendingDeleteId === connId) {
        pendingDeleteId = null;
    } else {
        pendingDeleteId = connId;
    }
    renderConnections();
}

async function confirmDelete(connId) {
    try {
        const res = await fetch(`/api/dashboard/connections/${connId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Delete failed', 'error'); return; }
        pendingDeleteId = null;
        await loadConnections();
        renderConnections();
        showToast(data.message, data.restart_required ? 'warning' : 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

async function toggleConnection(connId) {
    try {
        const res = await fetch(`/api/dashboard/connections/${connId}/toggle`, { method: 'PATCH' });
        const data = await res.json();
        if (!res.ok) { showToast(data.detail || 'Toggle failed', 'error'); return; }
        await loadConnections();
        renderConnections();
        showToast(data.message, 'success');
    } catch (e) {
        showToast('Network error: ' + e.message, 'error');
    }
}

// ============================================================
// NAVIGATION
// ============================================================

const NAV_ITEMS = [
    { key: 'overview',    icon: ICONS.barChart, label: 'Overview' },
    { key: 'connections', icon: ICONS.server,   label: 'Connections' },
    { key: 'costs',       icon: ICONS.dollar,   label: 'Costs' },
    { key: 'activity',   icon: ICONS.list,     label: 'Activity' },
];

function renderSidebar() {
    const nav = document.getElementById('sidebar');
    nav.innerHTML = NAV_ITEMS.map(item => `
        <button class="nav-btn ${currentView === item.key ? 'active' : ''}" onclick="showView('${item.key}')" data-view="${item.key}">
            ${item.icon} ${item.label}
        </button>
    `).join('') + `
        <div style="flex:1"></div>
        <div id="sidebar-footer">
            <div class="mono" style="font-size:11px;color:var(--text-dim)">v1.0.0</div>
            <div style="font-size:11px;color:var(--text-dim)">Apache 2.0</div>
        </div>
    `;
}

async function showView(view) {
    currentView = view;
    renderSidebar();
    await refreshView(view);
}

async function refreshView(view) {
    if (view === 'overview') {
        await Promise.all([loadStats(), loadUsage(currentPeriod), loadConnections()]);
        renderOverview();
    } else if (view === 'connections') {
        await loadConnections();
        renderConnections();
    } else if (view === 'costs') {
        await Promise.all([loadStats(), loadBudget(), loadCosts(), loadUsage('daily')]);
        renderCosts();
    } else if (view === 'activity') {
        await loadRequests(50);
        renderActivity();
    }
}

// ============================================================
// HEADER
// ============================================================

function renderHeader() {
    const active = connectionsData.filter(c => c.enabled).length;
    const total = connectionsData.length;
    const el = document.getElementById('header-conn-count');
    if (el) el.textContent = `${active} of ${total} active`;
}

// ============================================================
// INIT
// ============================================================

document.addEventListener('DOMContentLoaded', async () => {
    renderSidebar();
    await Promise.all([loadStats(), loadUsage('daily'), loadConnections(), loadRequests(50)]);
    renderHeader();
    renderOverview();
});
    </script>
</body>
</html>
